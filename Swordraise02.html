<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ì „ì„¤ì˜ ë ˆì „ë“œ â€” stable prototype</title>
  <style>
    :root{
      --bg:#0f120f;
      --panel:rgba(18,20,16,0.92);
      --panel2:rgba(24,26,20,0.90);
      --ink:#e8e2d6;
      --muted:rgba(232,226,214,0.72);
      --gold:rgba(255,215,128,1);
      --gold-2:rgba(255,215,128,0.22);
      --gold-3:rgba(255,215,128,0.12);
      --ok:rgba(120,255,190,0.10);
      --bad:rgba(255,120,120,0.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 50% -10%, rgba(255,215,128,0.08), transparent 55%),
                  radial-gradient(1000px 600px at 20% 30%, rgba(80,140,90,0.10), transparent 60%),
                  radial-gradient(900px 700px at 90% 60%, rgba(70,60,40,0.12), transparent 55%),
                  var(--bg);
      color:var(--ink);
      font-family: -apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      letter-spacing: 0.1px;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .topbar{
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
      padding:14px 14px 10px;border:1px solid var(--gold-2);border-radius:16px;
      background:linear-gradient(180deg, rgba(24,26,20,0.92), rgba(18,20,16,0.92));
    }
    .title{font-weight:900;font-size:18px}
    .subtitle{opacity:.75;font-size:12px;margin-top:4px}
    .stats{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      border:1px solid var(--gold-3);
      background:rgba(34,36,30,0.92);
      padding:8px 10px;border-radius:999px;font-weight:800;font-size:12px;
    }
    .grid{
      margin-top:14px;
      display:grid;gap:12px;
      grid-template-columns: 1.1fr 0.9fr;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .stats{justify-content:flex-start} }
    .card{
      border:1px solid var(--gold-2);
      background:var(--panel);
      border-radius:16px;
      overflow:hidden;
    }
    .card header{
      padding:12px 14px;
      border-bottom:1px solid var(--gold-3);
      background:var(--panel2);
    }
    .card header .h{font-weight:900}
    .card header .s{opacity:.75;font-size:12px;margin-top:2px}
    .card .body{padding:12px 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    .btn{
      border:1px solid var(--gold-2);
      background:rgba(34,36,30,0.92);
      color:inherit;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn.small{padding:7px 9px;border-radius:10px;font-size:12px}
    .btn.primary{ background:linear-gradient(180deg, rgba(255,215,128,0.18), rgba(34,36,30,0.92)); }
    .btn.danger{
      border-color:rgba(255,120,120,0.22);
      box-shadow:0 0 0 1px rgba(255,120,120,0.08) inset;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .kv{
      display:grid;grid-template-columns: 120px 1fr;gap:8px 12px;
      margin-top:8px;
    }
    .k{opacity:.75;font-size:12px}
    .v{font-weight:800}
    .hr{height:1px;background:var(--gold-3);margin:12px 0}
    .two{ display:grid;grid-template-columns:1fr 1fr;gap:10px; }
    @media (max-width:520px){ .two{grid-template-columns:1fr} }
    .slot{
      border:1px solid var(--gold-3);
      background:rgba(34,36,30,0.92);
      border-radius:14px;
      padding:10px 12px;
      position:relative;
      cursor:pointer;
    }
    .slot.active{outline:2px solid rgba(255,215,128,0.35)}
    .slot .tag{
      position:absolute;top:10px;right:10px;
      border:1px solid var(--gold-3);
      padding:4px 8px;border-radius:999px;font-size:11px;font-weight:900;opacity:.85;
    }
    .slot .name{font-weight:900}
    .slot .meta{opacity:.78;font-size:12px;margin-top:2px}
    .slot .meta2{opacity:.70;font-size:12px;margin-top:2px}
    input,select{
      border:1px solid var(--gold-3);
      background:rgba(34,36,30,0.92);
      color:inherit;border-radius:12px;
      padding:10px 10px;
      width:100%;
    }
    label{opacity:.8;font-size:12px;font-weight:800}
    .formgrid{display:grid;gap:8px}
    .form2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .chat-log{
      height:360px; overflow-y:auto; padding:12px 12px 18px;
      display:flex; flex-direction:column; gap:10px;
    }
    .msg{display:flex;gap:10px;align-items:flex-end}
    .msg .meta{opacity:.75;font-size:12px;min-width:54px;text-align:right}
    .bubble{
      max-width:78%;
      padding:10px 12px;border-radius:14px;
      line-height:1.25;font-size:14px;
      border:1px solid var(--gold-3);
      background:rgba(34,36,30,0.92);
    }
    .bubble.system{
      max-width:92%;
      margin:0 auto;
      text-align:center;
      font-weight:900;
      border-radius:999px;
      background:rgba(255,215,128,0.10);
      border:1px solid var(--gold-2);
    }
    .bubble.success{box-shadow:0 0 0 1px var(--ok) inset}
    .bubble.break{box-shadow:0 0 0 1px var(--bad) inset}
    .mini{opacity:.75;font-size:12px}
    .friends-list{
      border-top:1px solid var(--gold-3);
      padding:12px 14px 16px;
      display:flex;flex-direction:column;gap:10px;
    }
    .friend-card{
      border:1px solid var(--gold-3);
      background:rgba(34,36,30,0.92);
      border-radius:12px;padding:10px 12px;
      display:grid;grid-template-columns:1fr auto;gap:10px;
    }
    .friend-line1{font-weight:900}
    .friend-line2{opacity:.85;font-size:13px}
    .friend-line3{opacity:.72;font-size:12px}
    .friend-actions{display:flex;flex-direction:column;gap:6px}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(34,36,30,0.96);
      border:1px solid var(--gold-2);
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      opacity:0; pointer-events:none;
      transition:opacity .2s ease;
      max-width:92vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .toast.on{opacity:1}
    .muted{opacity:.75}
  
    /* modal popup */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.62);
      display:flex; align-items:center; justify-content:center;
      padding:16px;
      z-index:50;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease;
    }
    .backdrop.on{opacity:1; pointer-events:auto;}
    .modal{
      width:min(560px, 96vw);
      border:1px solid var(--gold-2);
      background:linear-gradient(180deg, rgba(24,26,20,0.96), rgba(18,20,16,0.96));
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 18px 60px rgba(0,0,0,0.55);
    }
    .modal header{
      padding:12px 14px;
      border-bottom:1px solid var(--gold-3);
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      background:rgba(34,36,30,0.45);
    }
    .modal header .mh{font-weight:900}
    .modal .content{padding:14px}
    .modal .content p{margin:0 0 10px; line-height:1.35}
    .modal .content p:last-child{margin-bottom:0}
    .modal .actions{
      padding:12px 14px;
      border-top:1px solid var(--gold-3);
      display:flex; justify-content:flex-end; gap:8px;
      background:rgba(34,36,30,0.30);
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">í”„ë¡œì íŠ¸ &lt;ì „ì„¤ì˜ ë ˆì „ë“œ&gt; â€” stable prototype</div>
        <div class="subtitle">ì›¹+ëª¨ë°”ì¼ì›¹ | ë¬´ë£Œê¸‰ì‹ì†Œ(24h 4íšŒ, 6h ì¿¨íƒ€ì„, 5,000G) | ê°•í™”: ì„±ê³µ/ìœ ì§€/í„°ì§ | +10 ì´ìƒ ì„±ê³µ/í„°ì§ ì›”ë“œ ì±„íŒ… ë°©ì†¡</div>
      </div>
      <div class="stats">
        <div class="pill">ğŸ’° ê³¨ë“œ: <span id="gold">0</span>G</div>
        <div class="pill">ğŸ§± ê³ ì² : <span id="scrap">0</span></div>
        <div class="pill">ğŸ† PVP: <span id="pvpStat">0W-0L</span> (ì—°ìŠ¹ <span id="streak">0</span>)</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <header>
          <div class="h">í”Œë ˆì´</div>
          <div class="s">ë¬´ê¸° ìŠ¬ë¡¯ 2ê°œ | ë°œêµ´â†’ê°•í™”â†’íŒë§¤ | PVPëŠ” ì†ì‹¤/íŒ¨ë°°ë¹„ìš© 0, ìŠ¹ë¦¬ ì‹œ ë³´ìƒ ì§€ê¸‰</div>
        </header>
        <div class="body">
          <div class="row space">
            <div class="row">
              <button id="btnCafeteria" class="btn primary">ğŸš ë¬´ë£Œê¸‰ì‹ì†Œ ë°›ê¸°</button>
              <div class="mini" id="cafeteriaInfo">â€”</div>
            </div>
            <div class="row">
              <button id="btnDig" class="btn">â›ï¸ ë°œêµ´/ê°ì •</button>
              <button id="btnPvp" class="btn">âš”ï¸ PVP</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row space">
            <div class="muted">ì„ íƒëœ ìŠ¬ë¡¯: <b id="selectedSlotLabel">ìŠ¬ë¡¯ 1</b></div>
            <div class="row">
              <button id="btnEnhance" class="btn primary">âœ¨ ê°•í™”</button>
              <button id="btnSell" class="btn">ğŸ·ï¸ íŒë§¤</button>
              <button id="btnSwitch" class="btn small">â†”ï¸ ìŠ¬ë¡¯ ì „í™˜</button>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div id="slot0" class="slot">
              <div class="tag">ìŠ¬ë¡¯ 1</div>
              <div class="name" id="slot0Name">â€”</div>
              <div class="meta" id="slot0Meta">â€”</div>
              <div class="meta2" id="slot0Meta2">â€”</div>
            </div>
            <div id="slot1" class="slot">
              <div class="tag">ìŠ¬ë¡¯ 2</div>
              <div class="name" id="slot1Name">â€”</div>
              <div class="meta" id="slot1Meta">â€”</div>
              <div class="meta2" id="slot1Meta2">â€”</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row space">
            <div>
              <div style="font-weight:900">ê³ ì² ìƒì </div>
              <div class="mini">ì½”ìŠ¤ë©”í‹±ì€ ë‚˜ì¤‘ì—. ì§€ê¸ˆì€ ì¬ë„ì „ìš©ë§Œ.</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">ì¼ë°˜ ë°œêµ´ê¶Œ</div><div class="v">10 ê³ ì²  â†’ 1íšŒ (ë¬´ë£Œ)</div>
            <div class="k">íŠ¹ìˆ˜ ë°œêµ´ê¶Œ</div><div class="v">25 ê³ ì²  â†’ 1íšŒ (íŠ¹ìˆ˜â†‘, ì¼ 4íšŒ)</div>
            <div class="k">ê³ ê¸‰ ë°œêµ´ê¶Œ</div><div class="v">60 ê³ ì²  â†’ 1íšŒ (ê³ ê¸‰â†‘, ì¼ 2íšŒ)</div>
            <div class="k">ë³´í˜¸ë¶€ì </div><div class="v">30 ê³ ì²  â†’ 1ê°œ (ë‹¤ìŒ í„°ì§ â†’ ìœ ì§€)</div>
            <div class="k">ì¬ë„ì „ê¶Œ</div><div class="v">15 ê³ ì²  â†’ 1ê°œ (ìœ ì§€ ì‹œ ë¬´ë£Œ ì¬ì‹œë„)</div>
          </div>

          <div class="row" style="margin-top:10px;gap:8px">
            <button id="buyDigN" class="btn small">ì¼ë°˜ ë°œêµ´ê¶Œ</button>
            <button id="buyDigS" class="btn small">íŠ¹ìˆ˜ ë°œêµ´ê¶Œ</button>
            <button id="buyDigA" class="btn small">ê³ ê¸‰ ë°œêµ´ê¶Œ</button>
            <button id="buyAmulet" class="btn small">ë³´í˜¸ë¶€ì </button>
            <button id="buyReroll" class="btn small">ì¬ë„ì „ê¶Œ</button>
          </div>

          <div class="hr"></div>

          <div class="row space">
            <div class="muted">ë³´ìœ : ë°œêµ´ê¶Œ(ì¼ë°˜ <b id="tN">0</b> / íŠ¹ìˆ˜ <b id="tS">0</b> / ê³ ê¸‰ <b id="tA">0</b>) Â· ë³´í˜¸ë¶€ì  <b id="amulet">0</b> Â· ì¬ë„ì „ê¶Œ <b id="reroll">0</b></div>
            <button id="btnReset" class="btn danger small">ì„¸ì´ë¸Œ ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div class="card">
        <header>
          <div class="h">ì›”ë“œ ì±„íŒ…</div>
          <div class="s">+10 ì´ìƒ ê°•í™” ì„±ê³µ/í„°ì§ + ì¡°ê±´ë¶€ PVP ìŠ¹ë¦¬ ë°©ì†¡</div>
        </header>
        <div id="chatLog" class="chat-log" aria-live="polite"></div>
        <div class="body" style="padding-top:0">
          <div class="row space">
            <button id="toggleAutoScroll" class="btn small">ìë™ ìŠ¤í¬ë¡¤: ON</button>
            <div class="row">
              <button id="clearChat" class="btn small">ì§€ìš°ê¸°</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <header>
          <div class="h">ë“±ë¡ ìœ ì €(ì¹œêµ¬) ê´€ë¦¬</div>
          <div class="s">PVP ëœë¤ ë§¤ì¹­ í’€ì— í¬í•¨ë©ë‹ˆë‹¤ (basePower ìë™ ì¶”ì²œ í¬í•¨)</div>
        </header>
        <div class="body">
          <form id="friendForm" class="formgrid">
            <div class="form2">
              <div>
                <label>ë‹‰ë„¤ì„</label>
                <input id="fNick" placeholder="ì˜ˆ: ê²¸ì—´ë¨" maxlength="12" required />
              </div>
              <div>
                <label>ë¬´ê¸°ëª…</label>
                <input id="fWeapon" placeholder="ì˜ˆ: ë¹ ë£¨ / ì¡´ íŒ”ë£¨ìŠ¤í‹°í”„ê²½" maxlength="18" required />
              </div>
            </div>

            <div class="form2">
              <div>
                <label>ë¬´ê¸° íƒ€ì…</label>
                <select id="fType" required>
                  <option value="ëŒ€ê²€">ëŒ€ê²€</option>
                  <option value="í•œì†ê²€">í•œì†ê²€</option>
                  <option value="í™œ">í™œ</option>
                  <option value="ì°½">ì°½</option>
                  <option value="ë„ë¼">ë„ë¼</option>
                  <option value="ë‘”ê¸°">ë‘”ê¸°</option>
                  <option value="ë¹ ë£¨">ë¹ ë£¨</option>
                  <option value="ìš”ìˆ ë´‰">ë§ˆë²•ì†Œë…€ìš”ìˆ ë´‰</option>
                  <option value="íŒ”ë£¨ìŠ¤í‹°í”„ê²½">ì¡´ íŒ”ë£¨ìŠ¤í‹°í”„ê²½</option>
                  <option value="ë ˆì´ì €ì´">ë ˆì´ì €ì´</option>
                </select>
              </div>
              <div>
                <label>ë“±ê¸‰</label>
                <select id="fTier" required>
                  <option value="ì¼ë°˜">ì¼ë°˜</option>
                  <option value="íŠ¹ìˆ˜">íŠ¹ìˆ˜</option>
                  <option value="ê³ ê¸‰">ê³ ê¸‰</option>
                </select>
              </div>
            </div>

            <div class="form2">
              <div>
                <label>ê°•í™”(+0~+30)</label>
                <input id="fEnh" type="number" min="0" max="30" value="1" required />
              </div>
              <div>
                <label>ê¸°ë³¸ë”œ(basePower)</label>
                <input id="fBase" type="number" min="80" max="140" value="100" required />
                <div class="mini muted">ë¬´ê¸° íƒ€ì…/ë“±ê¸‰ ì„ íƒ ì‹œ ìë™ ì¶”ì²œ</div>
              </div>
            </div>

            <div class="row">
              <button class="btn primary" type="submit">ì¹œêµ¬ ì¶”ê°€/ìˆ˜ì •</button>
              <button id="exportFriends" class="btn" type="button">ë‚´ë³´ë‚´ê¸°</button>
              <button id="importFriends" class="btn" type="button">ê°€ì ¸ì˜¤ê¸°</button>
              <button id="resetFriends" class="btn danger" type="button">ì „ì²´ ì‚­ì œ</button>
            </div>
          </form>
        </div>
        <div id="friendsList" class="friends-list"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">â€”</div>

  <div id="modalBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <div class="mh" id="modalTitle">â€”</div>
        <button class="btn small" id="modalClose" type="button">ë‹«ê¸°</button>
      </header>
      <div class="content" id="modalBody"></div>
      <div class="actions">
        <button class="btn primary" id="modalOk" type="button">í™•ì¸</button>
      </div>
    </div>
  </div>


<script>
const APP_VERSION = "1.1.0";

/** UUID helper (crypto.randomUUID fallback for older browsers) */
function uuid(){
  if (window.crypto && typeof window.crypto.randomUUID === "function") return window.crypto.randomUUID();
  // fallback RFC4122-ish
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
    const r = Math.random() * 16 | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

const SAVE_KEY = "legend_of_legend_stable_v1";
const FRIENDS_KEY = "legend_friends_v1";

function defaultWeaponStarter(){
  return {
    id: uuid(),
    type: "í•œì†ê²€",
    name: "ë‚¡ì€ ê²€",
    seriesKey: "rust",
    rootName: "ì „ì„¤ì˜ ê²€",
    tier: "ì¼ë°˜",
    enhance: 0,
    basePower: 100,
    baseValue: 1000,
    createdAt: Date.now()
  };
}

function defaultState(){
  return {
    version: APP_VERSION,
    starterGranted: true,
    gold: 100000,
    scrap: 0,
    cafeteria: { claims: [], lastAt: 0 },
    inventory: [ defaultWeaponStarter(), null ],
    selectedSlot: 0,
    tickets: { N:0, S:0, A:0 },
    amulet: 0,
    reroll: 0,
    daily: { dateKey: new Date().toISOString().slice(0,10), specialDigUsed:0, advancedDigUsed:0, amuletBought:0, rerollBought:0 },
    pvp: { wins:0, losses:0, winStreak:0, dailyCount:0 },
    me: { nickname: "í”Œë ˆì´ì–´" },
    friends: [],
    npcs: [
      { nickname:"ê¸‰ì‹í—Œí„°", weaponName:"ëŒ€ê²€", enhance:1, tierLabel:"ì¼ë°˜", basePower:101 },
      { nickname:"ë¹ ë£¨ì¥ì¸", weaponName:"ë¹ ë£¨", enhance:3, tierLabel:"íŠ¹ìˆ˜", basePower:99 },
      { nickname:"ì „ì„¤ë¯¸ë¦¬ë³´ê¸°", weaponName:"ì°½", enhance:9, tierLabel:"ì¼ë°˜", basePower:100 },
      { nickname:"ë ˆì´ì €ì¶©", weaponName:"ë ˆì´ì €ì´", enhance:7, tierLabel:"íŠ¹ìˆ˜", basePower:97 },
      { nickname:"ê³ ê¸‰ë¹ŒëŸ°", weaponName:"ë„ë¼", enhance:10, tierLabel:"ê³ ê¸‰", basePower:100 }
    ]
  };
}

function loadState(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    if(!s.inventory) s.inventory = [defaultWeaponStarter(), null];
    if(s.selectedSlot === undefined) s.selectedSlot = 0;
    if(!s.tickets) s.tickets = {N:0,S:0,A:0};
    if(s.amulet === undefined) s.amulet = 0;
    if(s.reroll === undefined) s.reroll = 0;
    if(!s.daily) s.daily = {dateKey:new Date().toISOString().slice(0,10), specialDigUsed:0, advancedDigUsed:0, amuletBought:0, rerollBought:0};
    if(!s.pvp) s.pvp = {wins:0,losses:0,winStreak:0,dailyCount:0};
    if(!s.me) s.me = {nickname:"í”Œë ˆì´ì–´"};
    
    // --- migrations / guards ---
    if(!s.version) s.version = "1.0.0";
    if(!s.cafeteria) s.cafeteria = { claims: [], lastAt: 0 };
    if(!Array.isArray(s.cafeteria.claims)) s.cafeteria.claims = [];
    if(typeof s.cafeteria.lastAt !== "number") s.cafeteria.lastAt = 0;

    if(typeof s.gold !== "number") s.gold = 0;
    if(typeof s.scrap !== "number") s.scrap = 0;

    if(!s.inventory) s.inventory = [defaultWeaponStarter(), null];
    if(s.selectedSlot === undefined) s.selectedSlot = 0;
    if(!s.tickets) s.tickets = {N:0,S:0,A:0};
    if(s.amulet === undefined) s.amulet = 0;
    if(s.reroll === undefined) s.reroll = 0;
    if(!s.daily) s.daily = {dateKey:new Date().toISOString().slice(0,10), specialDigUsed:0, advancedDigUsed:0, amuletBought:0, rerollBought:0};
    if(!s.pvp) s.pvp = {wins:0,losses:0,winStreak:0,dailyCount:0};
    if(!s.me) s.me = {nickname:"í”Œë ˆì´ì–´"};
    if(!Array.isArray(s.npcs)) s.npcs = defaultState().npcs;

    // starter grant (only once for old saves that had 0G and got stuck)
    if(!s.starterGranted){
      if(s.gold <= 0){
        s.gold = 100000;
        s.starterGranted = true;
        s._justGranted = true;
      }else{
        s.starterGranted = true;
      }
    }

    s.version = APP_VERSION;
return s;
  }catch{
    return defaultState();
  }
}
function saveState(){ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }

let state = loadState();

function ensureDaily(){
  const today = new Date().toISOString().slice(0,10);
  if(state.daily?.dateKey !== today){
    state.daily = {dateKey: today, specialDigUsed:0, advancedDigUsed:0, amuletBought:0, rerollBought:0};
    state.pvp.dailyCount = 0;
  }
}

const toastEl = document.getElementById("toast");
let toastTimer = null;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("on");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toastEl.classList.remove("on"), 1400);
}

const modalBackdrop = document.getElementById("modalBackdrop");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const modalOk = document.getElementById("modalOk");
const modalClose = document.getElementById("modalClose");

function showModal(title, html){
  modalTitle.textContent = title || "ì•Œë¦¼";
  modalBody.innerHTML = html || "";
  modalBackdrop.classList.add("on");
  modalBackdrop.setAttribute("aria-hidden","false");
}
function hideModal(){
  modalBackdrop.classList.remove("on");
  modalBackdrop.setAttribute("aria-hidden","true");
}
modalOk.addEventListener("click", hideModal);
modalClose.addEventListener("click", hideModal);
modalBackdrop.addEventListener("click", (e)=>{ if(e.target === modalBackdrop) hideModal(); });
document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && modalBackdrop.classList.contains("on")) hideModal(); });

function modalPara(lines){
  if(Array.isArray(lines)){
    return lines.map(l=>`<p>${escapeHtml(l)}</p>`).join("");
  }
  return `<p>${escapeHtml(String(lines||""))}</p>`;
}

const $ = (id)=>document.getElementById(id);
function fmt(n){ return (Math.round(n)).toLocaleString("ko-KR"); }
function nowHHMM() {
  const d = new Date();
  const hh = String(d.getHours()).padStart(2, "0");
  const mm = String(d.getMinutes()).padStart(2, "0");
  return `${hh}:${mm}`;
}
function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

let autoScroll = true;
$("toggleAutoScroll").addEventListener("click", ()=>{
  autoScroll = !autoScroll;
  $("toggleAutoScroll").textContent = `ìë™ ìŠ¤í¬ë¡¤: ${autoScroll ? "ON" : "OFF"}`;
});
$("clearChat").addEventListener("click", ()=>{ $("chatLog").innerHTML=""; });

function appendChat({ time, text, kind = "system" }) {
  const chatLog = $("chatLog");
  const row = document.createElement("div");
  row.className = "msg";
  if (kind === "system" || kind === "success" || kind === "break") {
    row.innerHTML = `<div class="bubble system ${kind}">[${escapeHtml(time)}] ${escapeHtml(text)}</div>`;
  } else {
    row.innerHTML = `<div class="meta">${escapeHtml(time)}</div><div class="bubble">${escapeHtml(text)}</div>`;
  }
  chatLog.appendChild(row);
  if (autoScroll) chatLog.scrollTop = chatLog.scrollHeight;
}

/* World logs */
let lastWorldPostAt = 0;
const WORLD_COOLDOWN_MS = 900;
const REACTIONS = ["ã…‹ã…‹ã…‹ã…‹ã…‹ã…‹","ë¯¸ì¹œâ€¦","ê¸‰ì‹ê°’ ë½‘ì•˜ë‹¤","ì™€ ì´ê±¸ ì´ê¸°ë„¤","ìƒëŒ€ ì–µìš¸í•˜ê² ë‹¤","ê·¸ë§Œí•´!!","ì˜¤ëŠ˜ ìš´ ë‹¤ ì¼ë‹¤","ì „ì„¤ì´ë‹¤â€¦","ì•¼ ê·¸ê±° í„°ì§€ëŠ” ê±° ì•„ë‹˜?","ë¶€ëŸ½ë‹¤â€¦"];
function maybeReaction(){
  if(Math.random() < 0.12){
    appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ’¬ ${REACTIONS[Math.floor(Math.random()*REACTIONS.length)]}` });
  }
}
function scrapOnBreak(enhance){ if(enhance < 10) return 1; if(enhance < 20) return 2; return 3; }
function postEnhanceWorldLog({ nickname, tierLabel, weaponName, oldEnhance, newEnhance, result }){
  const t = nowHHMM();
  const now = Date.now();
  if(result === "KEEP") return;
  if(now - lastWorldPostAt < WORLD_COOLDOWN_MS) return;
  lastWorldPostAt = now;

  if(result === "SUCCESS" && newEnhance >= 10){
    appendChat({ time:t, kind:"success", text:`ğŸ‰ [ê°•í™”ì„±ê³µ] ${nickname}ë‹˜ì´ [${tierLabel}] ${weaponName}ì„(ë¥¼) +${oldEnhance} â†’ +${newEnhance} ê°•í™”!` });
    maybeReaction();
  }
  if(result === "BREAK" && oldEnhance >= 10){
    const sc = scrapOnBreak(oldEnhance);
    appendChat({ time:t, kind:"break", text:`ğŸ’¥ [ê°•í™”í„°ì§] ${nickname}ë‹˜ì˜ [${tierLabel}] ${weaponName}(+${oldEnhance}) ì‚°í™”â€¦ (ê³ ì² ì¡°ê° +${sc})` });
    maybeReaction();
  }
}

/* Cafeteria */
const CAF_PAY = 5000;
const CAF_MAX_PER_24H = 4;
const CAF_COOLDOWN_MS = 6 * 60 * 60 * 1000;
function pruneCafClaims(){
  const now = Date.now();
  state.cafeteria.claims = (state.cafeteria.claims||[]).filter(ts => now - ts <= 24*60*60*1000);
}
function cafeteriaStatus(){
  pruneCafClaims();
  const used = state.cafeteria.claims.length;
  const remaining = Math.max(0, CAF_MAX_PER_24H - used);
  const now = Date.now();
  const nextIn = Math.max(0, CAF_COOLDOWN_MS - (now - (state.cafeteria.lastAt||0)));
  const can = remaining > 0 && nextIn === 0;
  return { used, remaining, nextIn, can };
}
function fmtMs(ms){
  const s = Math.ceil(ms/1000);
  const hh = String(Math.floor(s/3600)).padStart(2,"0");
  const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${hh}:${mm}:${ss}`;
}
function claimCafeteria(){
  ensureDaily();
  const st = cafeteriaStatus();
  if(!st.can){ toast("ì•„ì§ ê¸‰ì‹ ëª» ë°›ìŒâ€¦"); return; }
  state.gold += CAF_PAY;
  state.cafeteria.claims.push(Date.now());
  state.cafeteria.lastAt = Date.now();
  appendChat({ time: nowHHMM(), kind:"system", text:`ğŸš ë¬´ë£Œê¸‰ì‹ì†Œ: +${fmt(CAF_PAY)}G` });
  toast(`+${fmt(CAF_PAY)}G`);
  maybeReaction();
  saveState(); render();
}

/* Drop tables */
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function roll(p){ return Math.random() < p; }
const TIERS = [
  { tier:"ì¼ë°˜", p:0.82, powerMult:1.00, valueMult:1.00 },
  { tier:"íŠ¹ìˆ˜", p:0.15, powerMult:1.01, valueMult:1.60 },
  { tier:"ê³ ê¸‰", p:0.03, powerMult:1.04, valueMult:2.20 }
];
const TYPE_TABLE = [
  { type:"ëŒ€ê²€", basePower:[98,104], baseValue:[950,1050] },
  { type:"í•œì†ê²€", basePower:[96,102], baseValue:[950,1050] },
  { type:"í™œ", basePower:[95,101], baseValue:[950,1050] },
  { type:"ì°½", basePower:[96,102], baseValue:[950,1050] },
  { type:"ë„ë¼", basePower:[97,103], baseValue:[950,1050] },
  { type:"ë‘”ê¸°", basePower:[97,103], baseValue:[950,1050] }
];
const HUMOR_TYPES = [
  { type:"ë¹ ë£¨", basePower:[96,102], baseValue:[1000,1200] },
  { type:"ìš”ìˆ ë´‰", basePower:[94,100], baseValue:[900,1100] },
  { type:"íŒ”ë£¨ìŠ¤í‹°í”„ê²½", basePower:[95,101], baseValue:[1100,1400] },
  { type:"ë ˆì´ì €ì´", basePower:[93,99], baseValue:[1200,1600] }

/* Weapon naming series (ê²€í‚¤ìš°ê¸° ëŠë‚Œ) */
const SERIES = {
  chaos: {
    discovery: "í˜¼ëˆì´ ìŠ¤ë¯¼",
    stages: ["ë¶ˆì•ˆì •í•œ","ì™œê³¡ëœ","í†µì œë¶ˆëŠ¥ì˜","ì°¨ì›ì„ ì ì‹í•˜ëŠ”","ì¡´ì¬ë¥¼ ë©¸í•˜ëŠ”","ê³µí—ˆê°€ ì‘ì¶•ëœ","ê·¼ì›ì— ê°€ê¹Œì›Œì§„","ì°½ì„¸ë¥¼ ë¬¼ë“¤ì´ëŠ”"]
  },
  moon: {
    discovery: "ë‹¬ë¹›ì„ ë¨¸ê¸ˆì€",
    stages: ["ë¯¸ì•½í•œ ë‹¬ë¹›ì„ ë¨¸ê¸ˆì€","ì€ì€íˆ ë¹›ë‚˜ëŠ”","ì´ˆìŠ¹ë‹¬ì— ë§¹ì„¸í•œ","ë§Œì›”ì´ ë‚´ë ¤ì•‰ì€","ì›”ì‹ì´ ê¹ƒë“ ","ì„±ì¢Œë¥¼ ê°€ë¥´ëŠ”","ë°¤í•˜ëŠ˜ì„ ì°¢ëŠ”","ìƒˆë²½ì„ ì—¬ëŠ”"]
  },
  rust: {
    discovery: "ë…¹ìŠ¨ ì „ì„¤ì˜",
    stages: ["ë…¹ìŠ¨","ê¸íŒ","ê¸ˆ ê°„","ì‚ê±±ëŒ€ëŠ”","ê³ ëŒ€ì˜","ìŠíŒ ì˜ê´‘ì˜","ë˜ì‚´ì•„ë‚œ ì˜ê´‘ì˜","ì „ì„¤ì´ ê¹¨ì–´ë‚œ"]
  },
  abyss: {
    discovery: "ì‹¬ì—°ì´ ì†ì‚­ì´ëŠ”",
    stages: ["ì‹¬ì—°ì´ ì†ì‚­ì´ëŠ”","ì–´ë‘ ì´ ë‹¬ë¼ë¶™ì€","ë¬´ì €ê°±ì— ì –ì€","ì ˆë§ì„ ì‚¼í‚¨","ì‹¬ì—°ì„ ì°¢ëŠ”","ì‹¬ì—°ì„ ì§‘ì–´ì‚¼í‚¤ëŠ”","ì‹¬ì—°ì˜ ê´€ë¬¸ì´ ëœ","ì‹¬ì—° ê·¸ ìì²´ê°€ ëœ"]
  },
  saint: {
    discovery: "ì„±í”ì´ ë‚¨ì€",
    stages: ["ì„±í”ì´ ë‚¨ì€","ê¸°ë„ê°€ ìŠ¤ë¯¼","ì„œì•½ì„ í’ˆì€","êµ¬ì›ì„ ì•½ì†í•œ","ì‹¬íŒì„ ë‚´ë¦¬ëŠ”","ì„±ì—­ì„ ì§€í‚¤ëŠ”","ê³„ì‹œë¥¼ ìƒˆê¸´","ì‹ í™”ê°€ ëœ"]
  },
  thunder: {
    discovery: "ì²œë‘¥ì´ ë§´ë„ëŠ”",
    stages: ["ì²œë‘¥ì´ ë§´ë„ëŠ”","ë²ˆê°œê°€ íŠ€ëŠ”","ë‡Œê´‘ì´ ê°ë„ëŠ”","í­í’ì„ ë¶€ë¥´ëŠ”","í•˜ëŠ˜ì„ ê°€ë¥´ëŠ”","ë‡Œìš´ì„ ì ê·¸ëŠ”","ë‡Œëª…ì´ ì‘ì¶•ëœ","ì²œê³µì„ ì°¢ëŠ”"]
  }
};
const SERIES_KEYS = Object.keys(SERIES);

const ROOT_BY_TYPE = {
  "ëŒ€ê²€": "ëŒ€ê²€",
  "í•œì†ê²€": "ê²€",
  "í™œ": "í™œ",
  "ì°½": "ì°½",
  "ë„ë¼": "ë„ë¼",
  "ë‘”ê¸°": "ì² í‡´",
  "ë¹ ë£¨": "ë¹ ë£¨",
  "ìš”ìˆ ë´‰": "ìš”ìˆ ë´‰",
  "íŒ”ë£¨ìŠ¤í‹°í”„ê²½": "íŒ”ë£¨ìŠ¤í‹°í”„ê²½",
  "ë ˆì´ì €ì´": "ë ˆì´ì €ì´"
};

const RELIC_QUAL = {
  "ì¼ë°˜": "ë‚¡ì€ ìœ ë¬¼",
  "íŠ¹ìˆ˜": "ë¹›ë°”ëœ ìœ ë¬¼",
  "ê³ ê¸‰": "ë´‰ì¸ëœ ìœ ë¬¼"
};
const RELIC_PARTS = {
  "ëŒ€ê²€": ["ê²€ë‚ ","ì¹¼ì§‘","ì†ì¡ì´"],
  "í•œì†ê²€": ["ê²€ë‚ ","ì†ì¡ì´","ì¹¼ì§‘"],
  "í™œ": ["í™œëŒ€","í™œì‹œìœ„","ì†ì¡ì´"],
  "ì°½": ["ì°½ìë£¨","ì°½ë‚ ","ì¥ì‹ê¹ƒ"],
  "ë„ë¼": ["ë„ë¼ë‚ ","ìë£¨","ìê¸°"],
  "ë‘”ê¸°": ["ì² í‡´ë¨¸ë¦¬","ì†ì¡ì´","ëª»"],
  "ë¹ ë£¨": ["ë¹ ë£¨ë","ì†ì¡ì´","ë…¹ìŠ¨ ì´ë¹¨"],
  "ìš”ìˆ ë´‰": ["ë³„ì¥ì‹","ì†ì¡ì´","í•˜íŠ¸ì½”ì–´"],
  "íŒ”ë£¨ìŠ¤í‹°í”„ê²½": ["ê²€ì§‘(?)","ì†ì¡ì´","ëª…íŒ"],
  "ë ˆì´ì €ì´": ["ì—ë„ˆì§€ì…€","ë°©ì—´íŒ","ê·¸ë¦½"]
};

function pickSeriesKey(){
  // ê°€ë” ë‹¬ë¹› ì‹œë¦¬ì¦ˆë¥¼ ì¡°ê¸ˆ ë” ìì£¼ (ì˜ˆì‹œ ë¬¸êµ¬ ë•Œë¬¸)
  const r = Math.random();
  if(r < 0.22) return "moon";
  if(r < 0.40) return "chaos";
  return choice(SERIES_KEYS);
}

function computeWeaponName(w){
  const key = w.seriesKey || "rust";
  const series = SERIES[key] || SERIES.rust;
  const stage = Math.min(w.enhance || 0, series.stages.length-1);
  const root = w.rootName || `${key}ì˜ ${ROOT_BY_TYPE[w.type] || w.type}`;
  return `${series.stages[stage]} ${root}`;
}

function ensureWeaponNaming(w){
  if(!w) return;
  if(!w.seriesKey) w.seriesKey = pickSeriesKey();
  if(!w.rootName){
    // 'í˜¼ëˆì˜ ê²€' ê°™ì€ ëŠë‚Œìœ¼ë¡œ
    const noun = ROOT_BY_TYPE[w.type] || w.type;
    const series = SERIES[w.seriesKey] || SERIES.rust;
    // rootName: "í˜¼ëˆì˜ ê²€" / "ì‹¬ì—°ì˜ ì°½" ê°™ì€ êµ¬ë¬¸
    const rootPrefix = (w.seriesKey === "chaos") ? "í˜¼ëˆì˜" :
                       (w.seriesKey === "moon") ? "ë‹¬ë¹›ì˜" :
                       (w.seriesKey === "abyss") ? "ì‹¬ì—°ì˜" :
                       (w.seriesKey === "saint") ? "ì„±ì—­ì˜" :
                       (w.seriesKey === "thunder") ? "ì²œë‘¥ì˜" : "ì „ì„¤ì˜";
    w.rootName = `${rootPrefix} ${noun}`;
  }
  w.name = computeWeaponName(w);
}

function relicFindText(w){
  const q = RELIC_QUAL[w.tier] || "ë‚¡ì€ ìœ ë¬¼";
  const series = SERIES[w.seriesKey] || SERIES.rust;
  const part = choice(RELIC_PARTS[w.type] || ["íŒŒí¸","ì¡°ê°","ì”í•´"]);
  return `${q}ì—ì„œ â€˜${series.discovery} ${part}â€™ë¥¼ ë°œê²¬í–ˆë‹¤!`;
}
];
function pickTier(){
  const r = Math.random(); let acc = 0;
  for(const t of TIERS){ acc += t.p; if(r <= acc) return t; }
  return TIERS[0];
}
function maybeHumorReplace(tier){
  const baseChance = 0.02;
  const extra = (tier.tier === "ê³ ê¸‰") ? 0.03 : 0.0;
  if(roll(baseChance + extra)) return choice(HUMOR_TYPES);
  return null;
}
function generateWeapon({ forceTier=null } = {}){
  const tier = forceTier ? TIERS.find(t=>t.tier===forceTier) : pickTier();
  const humor = maybeHumorReplace(tier);
  const tinfo = humor ? humor : choice(TYPE_TABLE);
  const bp = randInt(tinfo.basePower[0], tinfo.basePower[1]);
  const bv = randInt(tinfo.baseValue[0], tinfo.baseValue[1]);
  let valueMultBonus = 1.0;
  let optionText = "";
  if(tier.tier === "íŠ¹ìˆ˜" && roll(0.5)){
    const opt = choice([{name:"ê¸ˆë‹ˆ ë°•í˜",mult:1.15},{name:"ìƒì ì£¼ê°€ ì¢‹ì•„í•¨",mult:1.25},{name:"ë„ë‚œí’ˆ ë”±ì§€",mult:1.40}]);
    valueMultBonus = opt.mult; optionText = opt.name;
  }
  const w = {
    id: uuid(),
    type: tinfo.type,
    name: tinfo.type,
    tier: tier.tier,
    enhance: 0,
    basePower: Math.round(bp * tier.powerMult),
    baseValue: Math.round(bv * tier.valueMult * valueMultBonus),
    optionText,
    seriesKey: pickSeriesKey(),
    rootName: "",
    createdAt: Date.now()
  };
  ensureWeaponNaming(w);
  return w;
}

const DIG_COST = 5000;
function canPay(cost){ return state.gold >= cost; }

function dig({ tier=null } = {}){
  ensureDaily();
  if(tier === "íŠ¹ìˆ˜"){
    if(state.tickets.S <= 0) return toast("íŠ¹ìˆ˜ ë°œêµ´ê¶Œì´ ì—†ì–´!");
    if(state.daily.specialDigUsed >= 4) return toast("ì˜¤ëŠ˜ íŠ¹ìˆ˜ ë°œêµ´ê¶Œ í•œë„(4) ë!");
    state.tickets.S -= 1; state.daily.specialDigUsed += 1;
  } else if(tier === "ê³ ê¸‰"){
    if(state.tickets.A <= 0) return toast("ê³ ê¸‰ ë°œêµ´ê¶Œì´ ì—†ì–´!");
    if(state.daily.advancedDigUsed >= 2) return toast("ì˜¤ëŠ˜ ê³ ê¸‰ ë°œêµ´ê¶Œ í•œë„(2) ë!");
    state.tickets.A -= 1; state.daily.advancedDigUsed += 1;
  } else if(tier === "ì¼ë°˜"){
    if(state.tickets.N <= 0) return toast("ì¼ë°˜ ë°œêµ´ê¶Œì´ ì—†ì–´!");
    state.tickets.N -= 1;
  } else {
    if(!canPay(DIG_COST)) return toast("ê³¨ë“œê°€ ë¶€ì¡±í•´â€¦");
    state.gold -= DIG_COST;
  }

  const w = generateWeapon({ forceTier: tier });

  const emptyIdx = state.inventory.findIndex(x => x === null);
  if(emptyIdx < 0){
    showModal("ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ë‹¤!", modalPara([
      "ë¬´ê¸° ìŠ¬ë¡¯ì´ 2ê°œ ëª¨ë‘ ì°¼ì–´.",
      "ë¬´ê¸°ë¥¼ íŒ”ê±°ë‚˜(íŒë§¤) / í„°ëœ¨ë¦¬ê±°ë‚˜(ê°•í™” ì‹¤íŒ¨) í•´ì•¼ ìƒˆ ë¬´ê¸°ë¥¼ ê°ì •í•  ìˆ˜ ìˆì–´!"
    ]));
    return;
  }

  const idx = emptyIdx;
  state.inventory[idx] = w;

  // popup + chat
  showModal("ìœ ë¬¼ ê°ì • ì™„ë£Œ", `<p>${escapeHtml(relicFindText(w))}</p><p class="muted">â†’ [${escapeHtml(w.tier)}] <b>${escapeHtml(w.name)}</b> (ìŠ¬ë¡¯ ${idx+1})</p>`);
  appendChat({ time: nowHHMM(), kind:"system", text:`â›ï¸ ë°œêµ´: [${w.tier}] ${w.name} íšë“! (ìŠ¬ë¡¯ ${idx+1})` });
  maybeReaction();
  saveState(); render();
}

/* Enhance */
function enhanceCost(currentPlus){
  const base = [10,20,50];
  const k = Math.floor(currentPlus / 3);
  const r = currentPlus % 3;
  return base[r] * (10 ** k);
}
const PROB = [
  {s:75,k:22,b:3},{s:72,k:23,b:5},{s:69,k:24,b:7},{s:66,k:25,b:9},{s:63,k:26,b:11},
  {s:60,k:27,b:13},{s:55,k:29,b:16},{s:50,k:31,b:19},{s:45,k:33,b:22},{s:40,k:35,b:25},
  {s:35,k:37,b:28},{s:32,k:39,b:29},{s:29,k:41,b:30},{s:26,k:43,b:31},{s:24,k:44,b:32},
  {s:22,k:45,b:33},{s:20,k:46,b:34},{s:18,k:47,b:35},{s:16,k:49,b:35},{s:15,k:50,b:35},
  {s:14,k:51,b:35},{s:13,k:52,b:35},{s:12,k:53,b:35},{s:11,k:54,b:35},{s:10,k:55,b:35},
  {s:9,k:56,b:35},{s:8,k:57,b:35},{s:7,k:58,b:35},{s:7,k:58,b:35},{s:6,k:59,b:35},{s:5,k:60,b:35}
];
function rollEnhanceResult(enh){
  const p = PROB[Math.min(enh, 30)];
  const r = Math.random()*100;
  if(r < p.s) return "SUCCESS";
  if(r < p.s + p.k) return "KEEP";
  return "BREAK";
}
function enhanceSelected(){
  ensureDaily();
  const idx = state.selectedSlot;
  const w = state.inventory[idx];
  if(!w) return toast("ìŠ¬ë¡¯ì´ ë¹„ì—ˆì–´!");
  const cost = enhanceCost(w.enhance);
  if(!canPay(cost)) return toast("ê³¨ë“œê°€ ë¶€ì¡±í•´â€¦");
  state.gold -= cost;

  const old = w.enhance;
  let result = rollEnhanceResult(old);

  if(result === "BREAK" && state.amulet > 0){
    state.amulet -= 1;
    result = "KEEP";
    appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ›¡ï¸ ë³´í˜¸ë¶€ì  ë°œë™! í„°ì§ì´ 'ìœ ì§€'ë¡œ ë³€ê²½ë¨` });
  }

  if(result === "SUCCESS"){
    w.enhance += 1;
    ensureWeaponNaming(w);
    showModal("ê°•í™” ì„±ê³µ!", `<p><b>+${old} â†’ +${w.enhance}</b></p><p>ì´ë¦„ì´ ë°”ë€Œì—ˆë‹¤: <b>${escapeHtml(w.name)}</b></p><p class="muted">ë¹„ìš©: -${fmt(cost)}G</p>`);
    appendChat({ time: nowHHMM(), kind:"system", text:`âœ¨ ê°•í™” ì„±ê³µ! +${old} â†’ +${w.enhance} (ë¹„ìš© -${fmt(cost)}G)` });
    postEnhanceWorldLog({ nickname: state.me.nickname, tierLabel: w.tier, weaponName: w.name, oldEnhance: old, newEnhance: w.enhance, result:"SUCCESS" });
  } else if(result === "KEEP"){
    showModal("ê°•í™” ìœ ì§€â€¦", `<p><b>+${old}</b> ê·¸ëŒ€ë¡œ ìœ ì§€ëë‹¤.</p><p class="muted">ë¹„ìš©: -${fmt(cost)}G</p>`);
    appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ˜¶ ê°•í™” ìœ ì§€â€¦ (+${old} ê·¸ëŒ€ë¡œ) (ë¹„ìš© -${fmt(cost)}G)` });
    if(state.reroll > 0){
      const use = confirm("ìœ ì§€! ì¬ë„ì „ê¶Œ 1ê°œë¥¼ ì¨ì„œ ë¬´ë£Œë¡œ í•œ ë²ˆ ë” ì‹œë„í• ê¹Œ?");
      if(use){
        state.reroll -= 1;
        const r2 = rollEnhanceResult(old);
        if(r2 === "SUCCESS"){
          w.enhance += 1;
          ensureWeaponNaming(w);
          showModal("ì¬ë„ì „ ì„±ê³µ!", `<p><b>+${old} â†’ +${w.enhance}</b></p><p>ì´ë¦„ì´ ë°”ë€Œì—ˆë‹¤: <b>${escapeHtml(w.name)}</b></p>`);
          appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ” ì¬ë„ì „ ì„±ê³µ! +${old} â†’ +${w.enhance}` });
          postEnhanceWorldLog({ nickname: state.me.nickname, tierLabel: w.tier, weaponName: w.name, oldEnhance: old, newEnhance: w.enhance, result:"SUCCESS" });
        } else if(r2 === "KEEP"){
          showModal("ì¬ë„ì „ë„ ìœ ì§€â€¦", `<p><b>+${old}</b> ê·¸ëŒ€ë¡œ ìœ ì§€ëë‹¤.</p>`);
          appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ” ì¬ë„ì „ë„ ìœ ì§€â€¦ (+${old})` });
        } else {
          let final = "BREAK";
          if(state.amulet > 0){
            state.amulet -= 1;
            final = "KEEP";
            appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ›¡ï¸ ë³´í˜¸ë¶€ì  ë°œë™! ì¬ë„ì „ í„°ì§ì´ 'ìœ ì§€'ë¡œ ë³€ê²½ë¨` });
          }
          if(final === "BREAK"){
            const sc = scrapOnBreak(old);
            state.scrap += sc;
            state.inventory[idx] = null;
            showModal("ì¬ë„ì „ í„°ì§!", `<p><b>${escapeHtml(w.name)}</b> ì´(ê°€) ì‚°í™”í–ˆë‹¤â€¦</p><p>ê³ ì²  +${sc}</p>`);
            appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ’¥ ì¬ë„ì „ í„°ì§! ë¬´ê¸°ê°€ ì‚°í™”â€¦ (ê³ ì²  +${sc})` });
            postEnhanceWorldLog({ nickname: state.me.nickname, tierLabel: w.tier, weaponName: w.name, oldEnhance: old, result:"BREAK" });
          } else {
            appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ” ì¬ë„ì „ ê²°ê³¼: ìœ ì§€ (+${old})` });
          }
        }
      }
    }
  } else {
    const sc = scrapOnBreak(old);
    state.scrap += sc;
    state.inventory[idx] = null;
    showModal("ê°•í™” ì‹¤íŒ¨!", `<p><b>${escapeHtml(w.name)}</b> ì´(ê°€) ì‚°í™”í–ˆë‹¤â€¦</p><p>ê³ ì²  +${sc}</p><p class="muted">ë¹„ìš©: -${fmt(cost)}G</p>`);
    appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ’¥ ê°•í™” ì‹¤íŒ¨! ë¬´ê¸°ê°€ ì‚°í™”â€¦ (ê³ ì²  +${sc}) (ë¹„ìš© -${fmt(cost)}G)` });
    postEnhanceWorldLog({ nickname: state.me.nickname, tierLabel: w.tier, weaponName: w.name, oldEnhance: old, result:"BREAK" });
  }

  saveState(); render();
}

/* Sell */
function sellSelected(){
  const idx = state.selectedSlot;
  const w = state.inventory[idx];
  if(!w) return toast("íŒ” ë¬´ê¸°ê°€ ì—†ì–´!");
  const sale = Math.round(w.baseValue * (1 + w.enhance * 0.12));
  state.gold += sale;
  appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ·ï¸ íŒë§¤: [${w.tier}] ${w.name}(+${w.enhance}) â†’ +${fmt(sale)}G` });
  state.inventory[idx] = null;
  saveState(); render();
}

/* Scrap shop */
function buyWithScrap(cost, label){
  if(state.scrap < cost){ toast("ê³ ì² ì´ ë¶€ì¡±í•´â€¦"); return false; }
  state.scrap -= cost;
  toast(`${label} êµí™˜!`);
  return true;
}
$("buyDigN").addEventListener("click", ()=>{ if(buyWithScrap(10,"ì¼ë°˜ ë°œêµ´ê¶Œ")){ state.tickets.N+=1; saveState(); render(); } });
$("buyDigS").addEventListener("click", ()=>{ ensureDaily(); if(state.daily.specialDigUsed>=4) return toast("ì˜¤ëŠ˜ íŠ¹ìˆ˜ ë°œêµ´ê¶Œ ì‚¬ìš©í•œë„(4) ë!"); if(buyWithScrap(25,"íŠ¹ìˆ˜ ë°œêµ´ê¶Œ")){ state.tickets.S+=1; saveState(); render(); } });
$("buyDigA").addEventListener("click", ()=>{ ensureDaily(); if(state.daily.advancedDigUsed>=2) return toast("ì˜¤ëŠ˜ ê³ ê¸‰ ë°œêµ´ê¶Œ ì‚¬ìš©í•œë„(2) ë!"); if(buyWithScrap(60,"ê³ ê¸‰ ë°œêµ´ê¶Œ")){ state.tickets.A+=1; saveState(); render(); } });
$("buyAmulet").addEventListener("click", ()=>{ ensureDaily(); if(state.daily.amuletBought>=3) return toast("ì˜¤ëŠ˜ ë³´í˜¸ë¶€ì  êµ¬ë§¤í•œë„(3) ë!"); if(buyWithScrap(30,"ë³´í˜¸ë¶€ì ")){ state.amulet+=1; state.daily.amuletBought+=1; saveState(); render(); } });
$("buyReroll").addEventListener("click", ()=>{ ensureDaily(); if(state.daily.rerollBought>=6) return toast("ì˜¤ëŠ˜ ì¬ë„ì „ê¶Œ êµ¬ë§¤í•œë„(6) ë!"); if(buyWithScrap(15,"ì¬ë„ì „ê¶Œ")){ state.reroll+=1; state.daily.rerollBought+=1; saveState(); render(); } });

/* PVP */
function clamp(min, x, max){ return Math.max(min, Math.min(x, max)); }
const PVP_BASE_REWARD = 4000;
function tierMultGold(tierLabel){ if(tierLabel==="íŠ¹ìˆ˜") return 1.4; if(tierLabel==="ê³ ê¸‰") return 1.8; return 1.0; }
function enhanceMultGold(oppEnhance){ return 1 + 0.10 * Math.max(0, oppEnhance - 1); }
function computePvpWinReward({ oppEnhance, oppTierLabel }){ return Math.round(PVP_BASE_REWARD * enhanceMultGold(oppEnhance) * tierMultGold(oppTierLabel)); }
function tierMultPower(tierLabel){ if(tierLabel==="íŠ¹ìˆ˜") return 1.01; if(tierLabel==="ê³ ê¸‰") return 1.04; return 1.0; }
function enhanceMultPower(enhance){ return 1 + 0.04 * enhance; }
function computePower({ basePower, enhance, tierLabel }){ return basePower * enhanceMultPower(enhance) * tierMultPower(tierLabel); }
function computeWinProb(myPower, oppPower){
  const ratio = (myPower - oppPower) / (myPower + oppPower);
  let p = 0.5 + ratio * 0.90;
  return clamp(0.20, p, 0.80);
}
function loadFriends(){ try{ const raw=localStorage.getItem(FRIENDS_KEY); return raw?JSON.parse(raw):[]; }catch{ return []; } }
function saveFriends(list){ localStorage.setItem(FRIENDS_KEY, JSON.stringify(list)); }
function syncFriendsToState(){ state.friends = loadFriends(); }

function buildOpponentPool(){
  return [...(state.friends||[]).map(f=>({nickname:f.nickname, weaponName:f.weaponName, enhance:f.enhance, tierLabel:f.tierLabel, basePower:f.basePower})), ...(state.npcs||[])];
}
let lastOppNickname = null;
function pickRandomOpponent(pool){
  if(!pool.length) return null;
  let opp = pool[Math.floor(Math.random()*pool.length)];
  if(pool.length>=2 && opp.nickname===lastOppNickname){
    let tries=3;
    while(tries-- > 0 && opp.nickname===lastOppNickname){
      opp = pool[Math.floor(Math.random()*pool.length)];
    }
  }
  lastOppNickname = opp.nickname;
  return opp;
}
let lastPvpWorldPostAt = 0;
const PVP_WORLD_COOLDOWN_MS = 900;
function shouldPostPvpWorldLog({ oppEnhance, oppTierLabel, reward, winStreak }){
  const milestone = [3,5,7,10,15,20].includes(winStreak);
  const bigOpp = oppEnhance >= 10;
  const bigTier = oppTierLabel === "ê³ ê¸‰";
  const bigReward = reward >= 8000;
  return milestone || bigOpp || bigTier || bigReward;
}
function postPvpWorldLog({ nickname, myWeaponName, myEnhance, oppNickname, oppWeaponName, oppEnhance, oppTierLabel, winStreak }){
  const t = nowHHMM();
  const now = Date.now();
  const reward = computePvpWinReward({ oppEnhance, oppTierLabel });
  if(!shouldPostPvpWorldLog({ oppEnhance, oppTierLabel, reward, winStreak })) return;
  if(now - lastPvpWorldPostAt < PVP_WORLD_COOLDOWN_MS) return;
  lastPvpWorldPostAt = now;
  const streakTag = winStreak >= 3 ? ` (ì—°ìŠ¹ ${winStreak})` : "";
  appendChat({ time:t, kind:"system", text:`âš”ï¸ [PVPìŠ¹ë¦¬] ${nickname} (+${myEnhance} ${myWeaponName}) â†’ ${oppNickname}ì˜ [${oppTierLabel}] ${oppWeaponName}(+${oppEnhance}) ê²©íŒŒ! ë³´ìƒ +${fmt(reward)}G${streakTag}` });
  maybeReaction();
}
function simulatePvp(){
  ensureDaily();
  syncFriendsToState();
  const pool = buildOpponentPool();
  const opp = pickRandomOpponent(pool);
  if(!opp) return toast("ìƒëŒ€ í’€ì´ ë¹„ì—ˆì–´!");
  const w = state.inventory[state.selectedSlot];
  if(!w) return toast("PVPí•  ë¬´ê¸°ê°€ ì—†ì–´! (ìŠ¬ë¡¯ì— ë¬´ê¸° í•„ìš”)");
  const myPower = computePower({basePower:w.basePower, enhance:w.enhance, tierLabel:w.tier});
  const oppPower = computePower(opp);
  const winProb = computeWinProb(myPower, oppPower);
  const win = Math.random() < winProb;
  state.pvp.dailyCount += 1;
  if(win){
    state.pvp.wins += 1;
    state.pvp.winStreak += 1;
    const reward = computePvpWinReward({ oppEnhance: opp.enhance, oppTierLabel: opp.tierLabel });
    state.gold += reward;
    appendChat({ time: nowHHMM(), kind:"system", text:`âœ… PVP ìŠ¹ë¦¬! (${Math.round(winProb*100)}% í™•ë¥ ) +${fmt(reward)}G` });
    postPvpWorldLog({ nickname: state.me.nickname, myWeaponName: w.name, myEnhance: w.enhance, oppNickname: opp.nickname, oppWeaponName: opp.weaponName, oppEnhance: opp.enhance, oppTierLabel: opp.tierLabel, winStreak: state.pvp.winStreak });
  }else{
    state.pvp.losses += 1;
    state.pvp.winStreak = 0;
    appendChat({ time: nowHHMM(), kind:"system", text:`âŒ PVP íŒ¨ë°°â€¦ (${Math.round(winProb*100)}% í™•ë¥ ) ë³´ìƒ 0G` });
  }
  saveState(); render();
}

/* Friends panel with basePower recommend */
function basePowerRecommendation(type, tierLabel){
  const lookup = {};
  for(const t of TYPE_TABLE) lookup[t.type]=t.basePower;
  for(const t of HUMOR_TYPES) lookup[t.type]=t.basePower;
  const range = lookup[type] || [96,102];
  const mid = Math.round((range[0]+range[1])/2);
  const jitter = Math.floor(Math.random()*3)-1;
  let base = mid + jitter;
  base = Math.round(base * tierMultPower(tierLabel));
  return clamp(80, base, 140);
}
function renderFriendsList(){
  const el = $("friendsList");
  const list = state.friends || [];
  if(list.length === 0){
    el.innerHTML = `<div class="muted">ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ í¼ì—ì„œ ì¶”ê°€í•´ì¤˜!</div>`;
    return;
  }
  el.innerHTML = list.map((f, idx) => `
    <div class="friend-card">
      <div>
        <div class="friend-line1">${escapeHtml(f.nickname)}</div>
        <div class="friend-line2">[${escapeHtml(f.tierLabel)}] ${escapeHtml(f.weaponName)} (+${f.enhance})</div>
        <div class="friend-line3">type ${escapeHtml(f.type||"-")} Â· basePower ${f.basePower}</div>
      </div>
      <div class="friend-actions">
        <button class="btn small" data-action="edit" data-idx="${idx}">ìˆ˜ì •</button>
        <button class="btn small danger" data-action="delete" data-idx="${idx}">ì‚­ì œ</button>
      </div>
    </div>
  `).join("");
  el.querySelectorAll("button[data-action]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const action = btn.dataset.action;
      const idx = Number(btn.dataset.idx);
      if(action==="delete") deleteFriend(idx);
      if(action==="edit") editFriend(idx);
    });
  });
}
function upsertFriendFromForm(){
  const nick = $("fNick").value.trim();
  const weapon = $("fWeapon").value.trim();
  const type = $("fType").value;
  const tier = $("fTier").value;
  const enh = Number($("fEnh").value);
  const base = Number($("fBase").value);
  if(!nick || !weapon) return toast("ë‹‰ë„¤ì„/ë¬´ê¸°ëª…ì„ ì±„ì›Œì¤˜!");
  if(!Number.isFinite(enh) || enh<0 || enh>30) return toast("ê°•í™” ìˆ˜ì¹˜ê°€ ì´ìƒí•´!");
  if(!Number.isFinite(base) || base<80 || base>140) return toast("ê¸°ë³¸ë”œì´ ì´ìƒí•´!");
  const friend = { nickname:nick, weaponName:weapon, type, tierLabel:tier, enhance:enh, basePower:base };
  const form = $("friendForm");
  const editing = form.dataset.editing;
  const list = state.friends || [];
  if(editing){
    list[Number(editing)] = friend;
    delete form.dataset.editing;
    toast("ìˆ˜ì • ì™„ë£Œ!");
    appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ‘¥ ì¹œêµ¬ ìˆ˜ì •: ${friend.nickname}` });
  }else{
    list.push(friend);
    toast("ì¹œêµ¬ ì¶”ê°€!");
    appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ‘¥ ì¹œêµ¬ ë“±ë¡: ${friend.nickname}` });
  }
  state.friends = list;
  saveFriends(list);
  renderFriendsList();
  form.reset();
  $("fEnh").value = 1;
  $("fType").value = type;
  $("fTier").value = tier;
  $("fBase").value = basePowerRecommendation(type, tier);
  saveState(); render();
}
function deleteFriend(idx){
  const list = state.friends || [];
  const removed = list.splice(idx,1)[0];
  state.friends = list;
  saveFriends(list);
  renderFriendsList();
  if(removed) appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ—‘ï¸ ì¹œêµ¬ ì‚­ì œ: ${removed.nickname}` });
  saveState(); render();
}
function editFriend(idx){
  const f = (state.friends||[])[idx];
  if(!f) return;
  $("fNick").value = f.nickname;
  $("fWeapon").value = f.weaponName;
  $("fType").value = f.type || "í•œì†ê²€";
  $("fTier").value = f.tierLabel;
  $("fEnh").value = f.enhance;
  $("fBase").value = f.basePower;
  $("friendForm").dataset.editing = String(idx);
  toast("ìˆ˜ì • ëª¨ë“œ");
}
function wireFriendsPanel(){
  const recompute = ()=>{
    const type = $("fType").value;
    const tier = $("fTier").value;
    $("fBase").value = basePowerRecommendation(type, tier);
    if(!$("fWeapon").value.trim()){
      $("fWeapon").value = (type === "ìš”ìˆ ë´‰") ? "ë§ˆë²•ì†Œë…€ìš”ìˆ ë´‰" : (type === "íŒ”ë£¨ìŠ¤í‹°í”„ê²½") ? "ì¡´ íŒ”ë£¨ìŠ¤í‹°í”„ê²½" : type;
    }
  };
  $("fType").addEventListener("change", recompute);
  $("fTier").addEventListener("change", recompute);
  $("friendForm").addEventListener("submit", (e)=>{ e.preventDefault(); upsertFriendFromForm(); });
  $("exportFriends").addEventListener("click", async ()=>{
    const data = JSON.stringify(state.friends||[], null, 2);
    try{ await navigator.clipboard.writeText(data); toast("í´ë¦½ë³´ë“œì— ë³µì‚¬!"); }
    catch{ prompt("ë³µì‚¬í•´ì„œ ì €ì¥í•´ì¤˜:", data); }
  });
  $("importFriends").addEventListener("click", ()=>{
    const json = prompt("ë¶™ì—¬ë„£ì„ ì¹œêµ¬ ëª©ë¡ JSON:");
    if(!json) return;
    try{
      const list = JSON.parse(json);
      if(!Array.isArray(list)) throw 0;
      state.friends = list.map(x=>({
        nickname:String(x.nickname||"ìµëª…").slice(0,12),
        weaponName:String(x.weaponName||"ê²€").slice(0,18),
        type:String(x.type||"í•œì†ê²€"),
        tierLabel:(["ì¼ë°˜","íŠ¹ìˆ˜","ê³ ê¸‰"].includes(x.tierLabel)?x.tierLabel:"ì¼ë°˜"),
        enhance:clamp(0, Number(x.enhance||1), 30),
        basePower:clamp(80, Number(x.basePower||100), 140),
      }));
      saveFriends(state.friends);
      renderFriendsList();
      toast("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!");
      saveState(); render();
    }catch{ toast("JSON í˜•ì‹ì´ ì´ìƒí•´!"); }
  });
  $("resetFriends").addEventListener("click", ()=>{
    if(!confirm("ì¹œêµ¬ë¥¼ ì „ë¶€ ì‚­ì œí• ê¹Œ?")) return;
    state.friends = [];
    saveFriends([]);
    renderFriendsList();
    toast("ì „ì²´ ì‚­ì œ!");
    saveState(); render();
  });
  $("fBase").value = basePowerRecommendation($("fType").value, $("fTier").value);
}

/* Bind buttons */
$("btnCafeteria").addEventListener("click", claimCafeteria);
$("btnDig").addEventListener("click", ()=>dig({tier:null}));
$("btnPvp").addEventListener("click", simulatePvp);
$("btnEnhance").addEventListener("click", enhanceSelected);
$("btnSell").addEventListener("click", sellSelected);
$("btnSwitch").addEventListener("click", ()=>{ state.selectedSlot = state.selectedSlot===0?1:0; saveState(); render(); });
$("slot0").addEventListener("click", ()=>{ state.selectedSlot=0; saveState(); render(); });
$("slot1").addEventListener("click", ()=>{ state.selectedSlot=1; saveState(); render(); });

$("btnReset").addEventListener("click", ()=>{
  if(!confirm("ì„¸ì´ë¸Œë¥¼ ì´ˆê¸°í™”í• ê¹Œ? (stable)")) return;
  localStorage.removeItem(SAVE_KEY);
  state = defaultState();
  syncFriendsToState();
  saveState();
  $("chatLog").innerHTML = "";
  appendChat({ time: nowHHMM(), kind:"system", text:"ì„¸ì´ë¸Œ ì´ˆê¸°í™” ì™„ë£Œ. ë‹¤ì‹œ ì‹œì‘!" });
  render();
});

// Right-click on dig button to use tickets quickly: N/S/A
$("btnDig").addEventListener("contextmenu", (e)=>{
  e.preventDefault();
  const pick = prompt("ë°œêµ´ê¶Œ ì‚¬ìš©? N=ì¼ë°˜, S=íŠ¹ìˆ˜, A=ê³ ê¸‰, ê·¸ëƒ¥ ì—”í„°=ìœ ë£Œë°œêµ´", "");
  if(pick === "N") dig({tier:"ì¼ë°˜"});
  else if(pick === "S") dig({tier:"íŠ¹ìˆ˜"});
  else if(pick === "A") dig({tier:"ê³ ê¸‰"});
  else dig({tier:null});
});

function renderTop(){
  $("gold").textContent = fmt(state.gold);
  $("scrap").textContent = fmt(state.scrap);
  $("pvpStat").textContent = `${state.pvp.wins}W-${state.pvp.losses}L`;
  $("streak").textContent = state.pvp.winStreak;
}
function renderCafeteria(){
  const st = cafeteriaStatus();
  $("cafeteriaInfo").textContent = `ìµœê·¼24h ë‚¨ì€ ê¸‰ì‹ ${st.remaining}/4 Â· ë‹¤ìŒê¹Œì§€ ${fmtMs(st.nextIn)}`;
  $("btnCafeteria").disabled = !st.can;
}
function renderSlots(){
  const s0 = state.inventory[0];
  const s1 = state.inventory[1];
  function setSlot(prefix, w, idx){
    $(prefix+"Name").textContent = w ? `[${w.tier}] ${w.name}` : "â€” ë¹„ì–´ìˆìŒ â€”";
    $(prefix+"Meta").textContent = w ? `+${w.enhance} Â· basePower ${w.basePower}` : "ë°œêµ´í•˜ê±°ë‚˜, ë‹¤ë¥¸ ìŠ¬ë¡¯ì—ì„œ ì˜®ê²¨ë´!";
    const opt = (w && w.optionText) ? ` Â· ì˜µì…˜: ${w.optionText}` : "";
    const cost = w ? enhanceCost(w.enhance) : 0;
    $(prefix+"Meta2").textContent = w ? `íŒë§¤ê°€ ì˜ˆìƒ: ${fmt(Math.round(w.baseValue*(1+w.enhance*0.12)))}G Â· ë‹¤ìŒ ê°•í™”ë¹„ìš©: ${fmt(cost)}G${opt}` : "â€”";
    const box = $(idx===0 ? "slot0" : "slot1");
    box.classList.toggle("active", state.selectedSlot===idx);
  }
  setSlot("slot0", s0, 0);
  setSlot("slot1", s1, 1);
  $("selectedSlotLabel").textContent = state.selectedSlot===0 ? "ìŠ¬ë¡¯ 1" : "ìŠ¬ë¡¯ 2";
}
function renderInventoryItems(){
  $("tN").textContent = state.tickets.N;
  $("tS").textContent = state.tickets.S;
  $("tA").textContent = state.tickets.A;
  $("amulet").textContent = state.amulet;
  $("reroll").textContent = state.reroll;
}
function render(){
  ensureDaily();
  pruneCafClaims();
  syncFriendsToState();
  renderTop();
  renderCafeteria();
  renderSlots();
  renderInventoryItems();
  renderFriendsList();
  saveState();
}

/* init */
syncFriendsToState();
wireFriendsPanel();
appendChat({ time: nowHHMM(), kind:"system", text:"ì›”ë“œ ì±„íŒ…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤." });
if(state._justGranted){
  appendChat({ time: nowHHMM(), kind:"system", text:`ğŸª™ ì‹œì‘ ì§€ì›ê¸ˆ ì§€ê¸‰: +${fmt(100000)}G (êµ¬ë²„ì „ ì„¸ì´ë¸Œ êµ¬ì¡° ë³µêµ¬)` });
  delete state._justGranted;
  saveState();
}
render();
</script>
</body>
</html>
