<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ì „ì„¤ì˜ ë ˆì „ë“œ â€” stable</title>
  <style>
    :root{
      --bg:#0f120f;
      --panel:rgba(18,20,16,0.92);
      --panel2:rgba(24,26,20,0.90);
      --ink:#e8e2d6;
      --muted:rgba(232,226,214,0.72);
      --gold:rgba(255,215,128,1);
      --gold-2:rgba(255,215,128,0.22);
      --gold-3:rgba(255,215,128,0.12);
      --ok:rgba(120,255,190,0.10);
      --bad:rgba(255,120,120,0.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 50% -10%, rgba(255,215,128,0.08), transparent 55%),
                  radial-gradient(1000px 600px at 20% 30%, rgba(80,140,90,0.10), transparent 60%),
                  radial-gradient(900px 700px at 90% 60%, rgba(70,60,40,0.12), transparent 55%),
                  var(--bg);
      color:var(--ink);
      font-family: -apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      letter-spacing: 0.1px;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .topbar{
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
      padding:14px 14px 10px;border:1px solid var(--gold-2);border-radius:16px;
      background:linear-gradient(180deg, rgba(24,26,20,0.92), rgba(18,20,16,0.92));
    }
    .title{font-weight:900;font-size:18px}
    .subtitle{opacity:.75;font-size:12px;margin-top:4px}
    .stats{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      border:1px solid var(--gold-3);
      background:rgba(34,36,30,0.92);
      padding:8px 10px;border-radius:999px;font-weight:800;font-size:12px;
    }
    .grid{
      margin-top:14px;
      display:grid;gap:12px;
      grid-template-columns: 1.1fr 0.9fr;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .stats{justify-content:flex-start} }
    .card{
      border:1px solid var(--gold-2);
      background:var(--panel);
      border-radius:16px;
      overflow:hidden;
    }
    .card header{
      padding:12px 14px;
      border-bottom:1px solid var(--gold-3);
      background:var(--panel2);
    }
    .card header .h{font-weight:900}
    .card header .s{opacity:.75;font-size:12px;margin-top:2px}
    .card .body{padding:12px 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    .btn{
      border:1px solid var(--gold-2);
      background:rgba(34,36,30,0.92);
      color:inherit;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn.small{padding:7px 9px;border-radius:10px;font-size:12px}
    .btn.primary{ background:linear-gradient(180deg, rgba(255,215,128,0.18), rgba(34,36,30,0.92)); }
    .btn.danger{ border-color:rgba(255,120,120,0.22); box-shadow:0 0 0 1px rgba(255,120,120,0.08) inset; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .hr{height:1px;background:var(--gold-3);margin:12px 0}
    .two{ display:grid;grid-template-columns:1fr 1fr;gap:10px; }
    @media (max-width:520px){ .two{grid-template-columns:1fr} }
    .slot{
      border:1px solid var(--gold-3);
      background:rgba(34,36,30,0.92);
      border-radius:14px;
      padding:10px 12px;
      position:relative;
      cursor:pointer;
    }
    .slot.active{outline:2px solid rgba(255,215,128,0.35)}
    .slot .tag{
      position:absolute;top:10px;right:10px;
      border:1px solid var(--gold-3);
      padding:4px 8px;border-radius:999px;font-size:11px;font-weight:900;opacity:.85;
    }
    .slot .name{font-weight:900}
    .slot .meta{opacity:.78;font-size:12px;margin-top:2px}
    .slot .meta2{opacity:.70;font-size:12px;margin-top:2px}
    .chat-log{
      height:360px; overflow-y:auto; padding:12px 12px 18px;
      display:flex; flex-direction:column; gap:10px;
    }
    .msg{display:flex;gap:10px;align-items:flex-end}
    .msg .meta{opacity:.75;font-size:12px;min-width:54px;text-align:right}
    .bubble{
      max-width:78%;
      padding:10px 12px;border-radius:14px;
      line-height:1.25;font-size:14px;
      border:1px solid var(--gold-3);
      background:rgba(34,36,30,0.92);
    }
    .bubble.system{
      max-width:92%;
      margin:0 auto;
      text-align:center;
      font-weight:900;
      border-radius:999px;
      background:rgba(255,215,128,0.10);
      border:1px solid var(--gold-2);
    }
    .bubble.success{box-shadow:0 0 0 1px var(--ok) inset}
    .bubble.break{box-shadow:0 0 0 1px var(--bad) inset}
    .mini{opacity:.75;font-size:12px}
    input,select{
      border:1px solid var(--gold-3);
      background:rgba(34,36,30,0.92);
      color:inherit;border-radius:12px;
      padding:10px 10px;
      width:100%;
    }
    label{opacity:.8;font-size:12px;font-weight:800}
    .formgrid{display:grid;gap:8px}
    .form2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .friends-list{
      border-top:1px solid var(--gold-3);
      padding:12px 14px 16px;
      display:flex;flex-direction:column;gap:10px;
    }
    .friend-card{
      border:1px solid var(--gold-3);
      background:rgba(34,36,30,0.92);
      border-radius:12px;padding:10px 12px;
      display:grid;grid-template-columns:1fr auto;gap:10px;
    }
    .friend-line1{font-weight:900}
    .friend-line2{opacity:.85;font-size:13px}
    .friend-line3{opacity:.72;font-size:12px}
    .friend-actions{display:flex;flex-direction:column;gap:6px}

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(34,36,30,0.96);
      border:1px solid var(--gold-2);
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      opacity:0; pointer-events:none;
      transition:opacity .2s ease;
      max-width:92vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      z-index:40;
    }
    .toast.on{opacity:1}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal-backdrop.on{ display:flex; }
    .modal{
      width:min(560px, 92vw);
      border:1px solid var(--gold-2);
      background:linear-gradient(180deg, rgba(24,26,20,0.98), rgba(18,20,16,0.98));
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 16px 60px rgba(0,0,0,0.55);
    }
    .modal header{
      padding:12px 14px;
      border-bottom:1px solid var(--gold-3);
      background:rgba(34,36,30,0.90);
      font-weight:900;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .modal header .kind{
      font-size:12px;
      opacity:.85;
      border:1px solid var(--gold-3);
      padding:4px 8px;
      border-radius:999px;
      background:rgba(255,215,128,0.10);
      white-space:nowrap;
    }
    .modal .content{ padding:14px; }
    .modal .content p{ margin:0 0 10px; line-height:1.45; white-space:pre-line; }
    .modal .content .big{ font-weight:900; font-size:16px; }
    .modal footer{
      padding:12px 14px;
      border-top:1px solid var(--gold-3);
      background:rgba(34,36,30,0.86);
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">í”„ë¡œì íŠ¸ &lt;ì „ì„¤ì˜ ë ˆì „ë“œ&gt; â€” stable</div>
        <div class="subtitle">ë¡œì»¬ ì €ì¥(localStorage) | ë¬´ë£Œê¸‰ì‹ì†Œ(24h 4íšŒ, 6h ì¿¨, 5,000G) | ìŠ¬ë¡¯ ë®ì–´ì“°ê¸° ê¸ˆì§€ | ë°œêµ´/ê°•í™”/íŒë§¤ | ê°•í™” ê²°ê³¼/ë°œêµ´ ê²°ê³¼ íŒì—…</div>
      </div>
      <div class="stats">
        <div class="pill">ğŸ’° ê³¨ë“œ: <span id="gold">0</span>G</div>
        <div class="pill">ğŸ§± ê³ ì² : <span id="scrap">0</span></div>
        <div class="pill">ğŸ† PVP: <span id="pvpStat">0W-0L</span> (ì—°ìŠ¹ <span id="streak">0</span>)</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <header>
          <div class="h">í”Œë ˆì´</div>
          <div class="s">ë¬´ê¸° ìŠ¬ë¡¯ 2ê°œ | ìŠ¬ë¡¯ì´ ê½‰ ì°¨ë©´ ë°œêµ´ ë¶ˆê°€(íŒ”ê±°ë‚˜/í„°ì ¸ì•¼ êµì²´)</div>
        </header>
        <div class="body">
          <div class="row space">
            <div class="row">
              <button id="btnCafeteria" class="btn primary">ğŸš ë¬´ë£Œê¸‰ì‹ì†Œ ë°›ê¸°</button>
              <div class="mini" id="cafeteriaInfo">â€”</div>
            </div>
            <div class="row">
              <button id="btnDig" class="btn">â›ï¸ ìœ ë¬¼ ë°œêµ´/ê°ì •</button>
              <button id="btnPvp" class="btn">âš”ï¸ PVP</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row space">
            <div class="mini">ì„ íƒëœ ìŠ¬ë¡¯: <b id="selectedSlotLabel">ìŠ¬ë¡¯ 1</b></div>
            <div class="row">
              <button id="btnEnhance" class="btn primary">âœ¨ ê°•í™”</button>
              <button id="btnSell" class="btn">ğŸ·ï¸ íŒë§¤</button>
              <button id="btnSwitch" class="btn small">â†”ï¸ ìŠ¬ë¡¯ ì „í™˜</button>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div id="slot0" class="slot">
              <div class="tag">ìŠ¬ë¡¯ 1</div>
              <div class="name" id="slot0Name">â€”</div>
              <div class="meta" id="slot0Meta">â€”</div>
              <div class="meta2" id="slot0Meta2">â€”</div>
            </div>
            <div id="slot1" class="slot">
              <div class="tag">ìŠ¬ë¡¯ 2</div>
              <div class="name" id="slot1Name">â€”</div>
              <div class="meta" id="slot1Meta">â€”</div>
              <div class="meta2" id="slot1Meta2">â€”</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row space">
            <div class="muted mini">ë°œêµ´ ë¹„ìš©(ìœ ë£Œ): 5,000G Â· ê°•í™” ë¹„ìš©: ê²€í‚¤ìš°ê¸°ì‹(10/20/50 Ã— 10^k)</div>
            <button id="btnReset" class="btn danger small">ì„¸ì´ë¸Œ ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div class="card">
        <header>
          <div class="h">ì›”ë“œ ì±„íŒ…</div>
          <div class="s">+10 ì´ìƒ ê°•í™” ì„±ê³µ/í„°ì§ ë°©ì†¡ Â· (ëŠë‚Œìš©) ëœë¤ ë¦¬ì•¡ì…˜</div>
        </header>
        <div id="chatLog" class="chat-log" aria-live="polite"></div>
        <div class="body" style="padding-top:0">
          <div class="row space">
            <button id="toggleAutoScroll" class="btn small">ìë™ ìŠ¤í¬ë¡¤: ON</button>
            <button id="clearChat" class="btn small">ì§€ìš°ê¸°</button>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <header>
          <div class="h">ë“±ë¡ ìœ ì €(ì¹œêµ¬) ê´€ë¦¬</div>
          <div class="s">PVP ëœë¤ ë§¤ì¹­ í’€ì— í¬í•¨ë©ë‹ˆë‹¤ (ë¡œì»¬ ì €ì¥)</div>
        </header>
        <div class="body">
          <form id="friendForm" class="formgrid">
            <div class="form2">
              <div>
                <label>ë‹‰ë„¤ì„</label>
                <input id="fNick" placeholder="ì˜ˆ: ê²¸ì—´ë¨" maxlength="12" required />
              </div>
              <div>
                <label>ë¬´ê¸°ëª…(ìƒëŒ€ìš©)</label>
                <input id="fWeapon" placeholder="ì˜ˆ: ë¹ ë£¨ / ì¡´ íŒ”ë£¨ìŠ¤í‹°í”„ê²½" maxlength="18" required />
              </div>
            </div>
            <div class="form2">
              <div>
                <label>ë“±ê¸‰</label>
                <select id="fTier" required>
                  <option value="ì¼ë°˜">ì¼ë°˜</option>
                  <option value="íŠ¹ìˆ˜">íŠ¹ìˆ˜</option>
                  <option value="ê³ ê¸‰">ê³ ê¸‰</option>
                </select>
              </div>
              <div>
                <label>ê°•í™”(+0~+30)</label>
                <input id="fEnh" type="number" min="0" max="30" value="1" required />
              </div>
            </div>
            <div class="form2">
              <div>
                <label>ê¸°ë³¸ë”œ(basePower 80~140)</label>
                <input id="fBase" type="number" min="80" max="140" value="100" required />
              </div>
              <div>
                <label>ë¹„ê³ </label>
                <input id="fNote" placeholder="ë©”ëª¨(ì„ íƒ)" maxlength="24" />
              </div>
            </div>
            <div class="row">
              <button class="btn primary" type="submit">ì¹œêµ¬ ì¶”ê°€/ìˆ˜ì •</button>
              <button id="exportFriends" class="btn" type="button">ë‚´ë³´ë‚´ê¸°</button>
              <button id="importFriends" class="btn" type="button">ê°€ì ¸ì˜¤ê¸°</button>
              <button id="resetFriends" class="btn danger" type="button">ì „ì²´ ì‚­ì œ</button>
            </div>
          </form>
        </div>
        <div id="friendsList" class="friends-list"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">â€”</div>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <header>
        <div id="modalTitle">ì•Œë¦¼</div>
        <div id="modalKind" class="kind">SYSTEM</div>
      </header>
      <div class="content">
        <p id="modalBody" class="big">â€”</p>
        <p id="modalSub" class="mini" style="opacity:.78"></p>
      </div>
      <footer>
        <button id="modalOk" class="btn primary">í™•ì¸</button>
      </footer>
    </div>
  </div>

<script>
const APP_VERSION = "2.0.0";
const START_GOLD = 100000;

// IMPORTANT: í‚¤ë¥¼ ì˜¬ë ¤ì„œ(ë²„ì „ì—…) ì´ì „ ê¼¬ì¸ ì„¸ì´ë¸Œ ì˜í–¥ ì°¨ë‹¨
const SAVE_KEY = "legend_of_legend_stable_v3";
const FRIENDS_KEY = "legend_friends_v1";

/** UUID helper */
function uuid(){
  if (window.crypto && typeof window.crypto.randomUUID === "function") return window.crypto.randomUUID();
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
    const r = Math.random() * 16 | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

const $ = (id)=>document.getElementById(id);
function fmt(n){ return (Math.round(n)).toLocaleString("ko-KR"); }
function clamp(min, x, max){ return Math.max(min, Math.min(x, max)); }
function nowHHMM(){
  const d = new Date();
  return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* Toast */
const toastEl = $("toast");
let toastTimer = null;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("on");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toastEl.classList.remove("on"), 1400);
}

/* Modal (popup) */
const modalBackdrop = $("modalBackdrop");
const modalTitleEl = $("modalTitle");
const modalBodyEl = $("modalBody");
const modalSubEl = $("modalSub");
const modalKindEl = $("modalKind");
const modalOkBtn = $("modalOk");
let _modalResolver = null;
function showModal(title, body, sub="", kind="SYSTEM"){
  modalTitleEl.textContent = title;
  modalBodyEl.textContent = body;
  modalSubEl.textContent = sub || "";
  modalKindEl.textContent = kind;
  modalBackdrop.classList.add("on");
  return new Promise((resolve)=>{ _modalResolver = resolve; });
}
function closeModal(){
  modalBackdrop.classList.remove("on");
  const r = _modalResolver; _modalResolver = null;
  if(r) r(true);
}
modalOkBtn.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click",(e)=>{ if(e.target===modalBackdrop) closeModal(); });
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && modalBackdrop.classList.contains("on")) closeModal(); });

/* Weapon Naming (ì†ì„±+ê°•í™” ë³€ì£¼) */
const ATTRIBUTES = ["ëŒ€ì§€", "ë°”ëŒ", "ë²ˆê°œ", "ë¬¼", "ì–¼ìŒ", "ë¹›", "ì¶•ë³µ", "íŒŒë©¸", "ì–´ë‘ ", "ìœ í˜¹", "ì„ ìœ¨", "ê³µí—ˆ", "ë…", "í™”ì—¼", "ì¤‘ë ¥", "ë¿Œë¦¬", "ê°€ì‹œ", "ì„ í˜ˆ", "ë¶„ë…¸", "ë‹¬ë¹›", "íƒœì–‘", "ë¶€ì‹"];
const ATTR_VARIANTS = {
  "ëŒ€ì§€": [
    "ëŒ€ì§€",
    "í† í™",
    "ì•”ë°˜",
    "ì‚°ë§¥",
    "ëŒ€ì§€ì˜ ì‹¬ì¥"
  ],
  "ë°”ëŒ": [
    "ë°”ëŒ",
    "ë¯¸í’",
    "ì²­í’",
    "ë†’ìƒˆë°”ëŒ",
    "í­í’"
  ],
  "ë²ˆê°œ": [
    "ë²ˆê°œ",
    "ì„¬ê´‘",
    "ë‡Œê´‘",
    "ë‚™ë¢°",
    "ì²œë‘¥ë²¼ë½"
  ],
  "ë¬¼": [
    "ë¬¼",
    "ë¬¼ê²°",
    "ì²­ë¥˜",
    "ê¸‰ë¥˜",
    "í•´ì¼"
  ],
  "ì–¼ìŒ": [
    "ì–¼ìŒ",
    "ì„œë¦¬",
    "ë¹™ê²°",
    "í•œë¹™",
    "ì˜ì›ì˜ ê²°ë¹™"
  ],
  "ë¹›": [
    "ë¹›",
    "ê´‘íœ˜",
    "ì„±ê´‘",
    "ì°¬ë€",
    "ì²œìƒì˜ ë¹›"
  ],
  "ì¶•ë³µ": [
    "ì¶•ë³µ",
    "ê°€í˜¸",
    "ì„±ì€",
    "ì€ì´",
    "ëŒ€ì¶•ë³µ"
  ],
  "íŒŒë©¸": [
    "íŒŒë©¸",
    "ëª°ë½",
    "ë¶•ê´´",
    "ë©¸ì ˆ",
    "ì¢…ë§"
  ],
  "ì–´ë‘ ": [
    "ì–´ë‘ ",
    "í‘ì˜",
    "ì•”í‘",
    "ì‹¬ì•¼",
    "ëì—†ëŠ” ì–´ë‘ "
  ],
  "ìœ í˜¹": [
    "ìœ í˜¹",
    "ë§¤í˜¹",
    "í˜„í˜¹",
    "ì¹˜ëª…",
    "ê¸ˆë‹¨ì˜ ìœ í˜¹"
  ],
  "ì„ ìœ¨": [
    "ì„ ìœ¨",
    "ê°€ë½",
    "í™”ìŒ",
    "í˜‘ì£¼",
    "ëŒ€í•©ì°½"
  ],
  "ê³µí—ˆ": [
    "ê³µí—ˆ",
    "í—ˆë¬´",
    "ë¬´(ç„¡)",
    "ê³µë°±",
    "ì‹¬ì—°ì˜ ê³µí—ˆ"
  ],
  "ë…": [
    "ë…",
    "ë§¹ë…",
    "ê·¹ë…",
    "ë…í˜ˆ",
    "ë§Œë…"
  ],
  "í™”ì—¼": [
    "í™”ì—¼",
    "ë¶ˆê½ƒ",
    "í™ì—¼",
    "ì—…í™”",
    "íƒœì´ˆì˜ ë¶ˆ"
  ],
  "ì¤‘ë ¥": [
    "ì¤‘ë ¥",
    "ì••ë ¥",
    "ì¸ë ¥",
    "ì¤‘ë ¥íŒŒ",
    "ì ˆëŒ€ì¤‘ë ¥"
  ],
  "ë¿Œë¦¬": [
    "ë¿Œë¦¬",
    "ì‹¹",
    "ê·¼ë§¥",
    "ê·¼ì›ë¿Œë¦¬",
    "ì„¸ê³„ìˆ˜ì˜ ë¿Œë¦¬"
  ],
  "ê°€ì‹œ": [
    "ê°€ì‹œ",
    "ììƒ",
    "ê·¹ì¹¨",
    "ë§Œê°€ì‹œ",
    "ì² ê°€ì‹œì˜ ì™•ê´€"
  ],
  "ì„ í˜ˆ": [
    "ì„ í˜ˆ",
    "í•ë¹›",
    "í˜ˆí™",
    "í˜ˆìš°",
    "ì‹¬ì¥í˜ˆ"
  ],
  "ë¶„ë…¸": [
    "ë¶„ë…¸",
    "ê²©ë…¸",
    "ê´‘ë¶„",
    "í­ë…¸",
    "ì‹ ë“¤ì˜ ë¶„ë…¸"
  ],
  "ë‹¬ë¹›": [
    "ë‹¬ë¹›",
    "ì€ì›”",
    "ì›”ê´‘",
    "ë§Œì›”",
    "ì›”ì‹ì˜ ë¹›"
  ],
  "íƒœì–‘": [
    "íƒœì–‘",
    "ì¼ê´‘",
    "í™©ê¸ˆë¹›",
    "ì •ì˜¤",
    "ì´ˆì‹ ì„±ì˜ ë¹›"
  ],
  "ë¶€ì‹": [
    "ë¶€ì‹",
    "ë…¹",
    "ì‚°í™”",
    "ì¹¨ì‹",
    "ë§Œë¶€ì‹"
  ]
};

const TYPE_FLAVOR = {
  "ëŒ€ê²€": ["ì”í–¥","ì¤‘ì‹¬ì¶”","ì§€ì¶•","íšŒì „ë‚ ","ë‚™í•˜"],
  "í•œì†ê²€": ["íœ˜íŒŒëŒ","í•œì¤„ê¸°","ì¹¼ë","ë§ˆì¹¨í‘œ","ìˆ¨ê²°"],
  "í™œ": ["í˜„","ë¹„ìƒ","ê¹ƒ","ì‹œìœ„","í˜¸í¡"],
  "ì°½": ["ì°½ìë£¨","ê´€í†µ","ëŒê²©","ì¥ëŒ€","ì§ì„ "],
  "ë„ë¼": ["ë„ë¼ë‚ ","ê· ì—´","ìª¼ê°œê¸°","ì ˆë‹¨","ë‚™ì°¨"],
  "ë‘”ê¸°": ["ë§ì¹˜ë¨¸ë¦¬","ì¶©ê²©","ì§„ë™","ìš¸ë¦¼","ë‚™ì„"],
  "ë¹ ë£¨": ["ë¹ ë£¨","ì² ì„±ë¶„","ê³µì‚¬ì¥","ëšë°°ê¸°","ìƒí™œì˜ ì§€í˜œ"],
  "ìš”ìˆ ë´‰": ["ë°˜ì§","ë³€ì‹ ","ë¦¬ë³¸","ë³„ê°€ë£¨","ë§ˆë²•ì§„"],
  "íŒ”ë£¨ìŠ¤í‹°í”„ê²½": ["ê²¸ì—´","ì¶©ì„±","ê¸°ì‚¬ë„","ëª…ì˜ˆ","ì–´ì „"],
  "ë ˆì´ì €ì´": ["ê´‘ì„ ","ì¡°ì¤€","ë°œê´‘","ìŠ¤ìº”","ê³¼ì—´"]
};

function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function roll(p){ return Math.random() < p; }

function weaponNounFromType(type){
  if(type==="ëŒ€ê²€" || type==="í•œì†ê²€") return "ê²€";
  if(type==="í™œ") return "í™œ";
  if(type==="ì°½") return "ì°½";
  if(type==="ë„ë¼") return "ë„ë¼";
  if(type==="ë‘”ê¸°") return "ë‘”ê¸°";
  return type;
}
function ensureNameState(w){
  if(!w.attr) w.attr = choice(ATTRIBUTES);
  if(!w.nameHistory) w.nameHistory = {};
  if(!w.displayName) w.displayName = "";
  return w;
}
function attrVariant(attr, enhance){
  const v = ATTR_VARIANTS[attr] || [attr,attr,attr,attr,attr];
  if(enhance >= 10) return v[4] || v[v.length-1];
  if(enhance >= 3)  return v[3] || v[v.length-1];
  if(enhance === 2) return v[2] || v[v.length-1];
  if(enhance === 1) return v[1] || v[v.length-1];
  return v[0] || attr;
}
function nameTemplate(type, enhance){
  const N = weaponNounFromType(type);
  const F = choice(TYPE_FLAVOR[type] || ["ì”í–¥","íŒŒí¸","ê¸°ì–µ","í”ì "]);
  if(enhance === 1){
    return choice([
      "{A}ì„ ë¶€ë¥´ëŠ” {F}{N}",
      "{A}ì˜ ìˆ¨ê²°ì´ ê¹ƒë“  {N}",
      "{A}ì„ ëŒì–´ëª¨ìœ¼ëŠ” {F}{N}"
    ]);
  }
  if(enhance === 2){
    return choice([
      "{A}ì˜ ì†Œë¦¬ë¡œ ê°€ë¥´ëŠ” {N}",
      "{A}ì˜ ê²°ì„ íƒ€ëŠ” {F}{N}",
      "{A}ì˜ íŒŒì¥ì„ ë² ì–´ë‚´ëŠ” {N}"
    ]);
  }
  if(enhance >= 3 && enhance < 10){
    return choice([
      "{A} ì¼ë³€ë„ì˜ {N}",
      "{A}ì— ê¸¸ë“¤ì—¬ì§„ {F}{N}",
      "{A}ì„ ì•ì„¸ìš´ {N}",
      "{A}ì˜ ìœ¤ê³½ì„ í›”ì¹œ {N}"
    ]);
  }
  return choice([
    "{A}ì˜ ê´‘ì‹œê³¡",
    "{A}ì˜ ë ˆí€´ì—  {N}",
    "{A}ì˜ ëŒ€ì„œì‚¬ì‹œ",
    "{A}ë¡œ ì§ì¡°ëœ {N}",
    "{A}ì˜ ì¢…ë§‰ì„ ì—¬ëŠ” {N}"
  ]);
}
function makeDisplayName(w){
  ensureNameState(w);
  const N = weaponNounFromType(w.type);
  if(w.enhance <= 0) return `${N}(ë‚¡ì€ ${w.attr})`;
  const A = attrVariant(w.attr, w.enhance);
  const F = choice(TYPE_FLAVOR[w.type] || ["ì”í–¥","íŒŒí¸","ê¸°ì–µ","í”ì "]);
  const tpl = nameTemplate(w.type, w.enhance);
  return tpl.replaceAll("{A}", A).replaceAll("{F}", F).replaceAll("{N}", N);
}
function updateDisplayName(w){
  ensureNameState(w);
  const k = String(w.enhance);
  if(!w.nameHistory[k]) w.nameHistory[k] = makeDisplayName(w);
  w.displayName = w.nameHistory[k];
}

/* Core state */
function defaultWeaponStarter(){
  const w = {
    id: uuid(),
    type: "í•œì†ê²€",
    tier: "ì¼ë°˜",
    enhance: 0,
    basePower: 100,
    baseValue: 1000,
    relicGrade: "ë‚¡ì€",
    attr: null,
    nameHistory: null,
    displayName: "",
    createdAt: Date.now()
  };
  updateDisplayName(w);
  return w;
}
function defaultState(){
  return {
    version: APP_VERSION,
    gold: START_GOLD,
    scrap: 0,
    cafeteria: { claims: [], lastAt: 0 },
    inventory: [ defaultWeaponStarter(), null ],
    selectedSlot: 0,
    pvp: { wins:0, losses:0, winStreak:0 },
    me: { nickname:"í”Œë ˆì´ì–´" },
    npcs: [
      { nickname:"ê¸‰ì‹í—Œí„°", weaponName:"ëŒ€ê²€", enhance:1, tierLabel:"ì¼ë°˜", basePower:101 },
      { nickname:"ë¹ ë£¨ì¥ì¸", weaponName:"ë¹ ë£¨", enhance:3, tierLabel:"íŠ¹ìˆ˜", basePower:99 },
      { nickname:"ì „ì„¤ë¯¸ë¦¬ë³´ê¸°", weaponName:"ì°½", enhance:9, tierLabel:"ì¼ë°˜", basePower:100 },
      { nickname:"ë ˆì´ì €ì¶©", weaponName:"ë ˆì´ì €ì´", enhance:7, tierLabel:"íŠ¹ìˆ˜", basePower:97 },
      { nickname:"ê³ ê¸‰ë¹ŒëŸ°", weaponName:"ë„ë¼", enhance:10, tierLabel:"ê³ ê¸‰", basePower:100 }
    ]
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    if(typeof s.gold !== "number" || !Number.isFinite(s.gold) || s.gold <= 0) s.gold = START_GOLD;
    if(typeof s.scrap !== "number" || !Number.isFinite(s.scrap) || s.scrap < 0) s.scrap = 0;
    if(!s.cafeteria) s.cafeteria = { claims: [], lastAt: 0 };
    if(!Array.isArray(s.cafeteria.claims)) s.cafeteria.claims = [];
    if(typeof s.cafeteria.lastAt !== "number" || !Number.isFinite(s.cafeteria.lastAt)) s.cafeteria.lastAt = 0;
    if(!Array.isArray(s.inventory)) s.inventory = [defaultWeaponStarter(), null];
    if(s.selectedSlot !== 0 && s.selectedSlot !== 1) s.selectedSlot = 0;
    if(!s.pvp) s.pvp = { wins:0, losses:0, winStreak:0 };
    if(!s.me) s.me = { nickname:"í”Œë ˆì´ì–´" };
    for(const it of (s.inventory||[])){ if(it){ updateDisplayName(it); } }
    s.version = APP_VERSION;
    return s;
  }catch{
    return defaultState();
  }
}
function saveState(){ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
let state = loadState();

/* World chat */
let autoScroll = true;
$("toggleAutoScroll").addEventListener("click", ()=>{
  autoScroll = !autoScroll;
  $("toggleAutoScroll").textContent = `ìë™ ìŠ¤í¬ë¡¤: ${autoScroll ? "ON" : "OFF"}`;
});
$("clearChat").addEventListener("click", ()=>{ $("chatLog").innerHTML=""; });

function appendChat({ time, text, kind="system" }){
  const chatLog = $("chatLog");
  const row = document.createElement("div");
  row.className = "msg";
  if(kind === "system" || kind === "success" || kind === "break"){
    row.innerHTML = `<div class="bubble system ${kind}">[${escapeHtml(time)}] ${escapeHtml(text)}</div>`;
  }else{
    row.innerHTML = `<div class="meta">${escapeHtml(time)}</div><div class="bubble">${escapeHtml(text)}</div>`;
  }
  chatLog.appendChild(row);
  if(autoScroll) chatLog.scrollTop = chatLog.scrollHeight;
}
const REACTIONS = ["ã…‹ã…‹ã…‹ã…‹ã…‹ã…‹","ë¯¸ì¹œâ€¦","ê¸‰ì‹ê°’ ë½‘ì•˜ë‹¤","ì™€ ì´ê±¸ ì´ê¸°ë„¤","ë¶€ëŸ½ë‹¤â€¦","ì „ì„¤ì´ë‹¤â€¦","ê·¸ë§Œí•´!!","ì•¼ ê·¸ê±° í„°ì§€ëŠ” ê±° ì•„ë‹˜?"];
function maybeReaction(){ if(Math.random() < 0.12) appendChat({time:nowHHMM(), kind:"system", text:`ğŸ’¬ ${REACTIONS[Math.floor(Math.random()*REACTIONS.length)]}`}); }

/* Cafeteria */
const CAF_PAY = 5000;
const CAF_MAX_PER_24H = 4;
const CAF_COOLDOWN_MS = 6*60*60*1000;

function normalizeCafeteria(){
  if(!state.cafeteria) state.cafeteria = { claims: [], lastAt: 0 };
  if(!Array.isArray(state.cafeteria.claims)) state.cafeteria.claims = [];
  const now = Date.now();
  state.cafeteria.claims = state.cafeteria.claims.filter(ts => typeof ts==="number" && ts <= now);
  if(typeof state.cafeteria.lastAt !== "number" || !Number.isFinite(state.cafeteria.lastAt) || state.cafeteria.lastAt > now) state.cafeteria.lastAt = 0;
}
function pruneCafClaims(){
  normalizeCafeteria();
  const now = Date.now();
  state.cafeteria.claims = state.cafeteria.claims.filter(ts => now - ts <= 24*60*60*1000);
}
function fmtMs(ms){
  const s = Math.ceil(ms/1000);
  const hh = String(Math.floor(s/3600)).padStart(2,"0");
  const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${hh}:${mm}:${ss}`;
}
function cafeteriaStatus(){
  pruneCafClaims();
  const used = state.cafeteria.claims.length;
  const remaining = Math.max(0, CAF_MAX_PER_24H - used);
  const now = Date.now();
  const nextIn = Math.max(0, CAF_COOLDOWN_MS - (now - (state.cafeteria.lastAt||0)));
  const can = remaining > 0 && nextIn === 0;
  return {used, remaining, nextIn, can};
}
function claimCafeteria(){
  const st = cafeteriaStatus();
  if(!st.can){
    showModal("ë¬´ë£Œê¸‰ì‹ì†Œ", "ì•„ì§ ë°›ì„ ìˆ˜ ì—†ì–´â€¦", `ë‚¨ì€ ê¸‰ì‹ ${st.remaining}/4 Â· ë‹¤ìŒê¹Œì§€ ${fmtMs(st.nextIn)}`, "CAFETERIA");
    return;
  }
  state.gold += CAF_PAY;
  state.cafeteria.claims.push(Date.now());
  state.cafeteria.lastAt = Date.now();
  appendChat({time:nowHHMM(), kind:"system", text:`ğŸš ë¬´ë£Œê¸‰ì‹ì†Œ: +${fmt(CAF_PAY)}G`});
  maybeReaction();
  toast(`+${fmt(CAF_PAY)}G`);
  showModal("ë¬´ë£Œê¸‰ì‹ì†Œ", `+${fmt(CAF_PAY)}G ì§€ê¸‰!`, `ë‚¨ì€ ê¸‰ì‹ ${cafeteriaStatus().remaining}/4`, "CAFETERIA");
  saveState(); render();
}

/* Relic / weapon generation */
const RELIC_GRADES = [
  { grade:"ë‚¡ì€", p:0.70 },
  { grade:"ë¹›ë°”ëœ", p:0.25 },
  { grade:"ë´‰ì¸ëœ", p:0.05 }
];
const RELIC_NOUNS = ["ê²€ì§‘","ì¹¼ë‚  ì¡°ê°","ì°½ìë£¨","í™œëŒ€","ë„ë¼ë‚ ","ë§ì¹˜ë¨¸ë¦¬","ê°€ë“œ","ì†ì¡ì´","íŒŒí¸","ë¶€ì "];
const RELIC_ADJ = ["ë‹¬ë¹›ì„ ë¨¸ê¸ˆì€","í•ìêµ­ì´ ë‚¨ì€","ë°”ëŒì´ ê¹ƒë“ ","ê²€ì€ ì¬ê°€ ë¬»ì€","ëˆˆë¬¼ë¡œ ì –ì€","ì†ì‚­ì„ì´ ìƒˆê²¨ì§„","ê¸ˆì´ ê°„","ì´ëª…ì´ ìš¸ë¦¬ëŠ”","ì´ìƒí•˜ê²Œ ë°˜ì§ì´ëŠ”","ë„ë¬´ì§€ ë‹¦ì´ì§€ ì•ŠëŠ”"];
function rollRelicGrade(){
  const r = Math.random(); let acc = 0;
  for(const g of RELIC_GRADES){ acc += g.p; if(r <= acc) return { grade:g.grade, relicName:`${choice(RELIC_ADJ)} ${choice(RELIC_NOUNS)}`}; }
  return { grade:"ë‚¡ì€", relicName:`${choice(RELIC_ADJ)} ${choice(RELIC_NOUNS)}` };
}
function relicFlavorText(grade){
  if(grade==="ë´‰ì¸ëœ") return "â€¦ì†ëì´ ì–¼ì–´ë¶™ëŠ”ë‹¤. ë´‰ì¸ì´ í’€ë¦¬ëŠ” ì†Œë¦¬ê°€ ë“¤ë¦°ë‹¤.";
  if(grade==="ë¹›ë°”ëœ") return "ë¨¼ì§€ ì†ì—ì„œ í¬ë¯¸í•œ ê´‘íƒì´ ë²ˆëœ©ì¸ë‹¤. ì˜¤ë˜ëœ ê¸°ì–µì˜ ëƒ„ìƒˆê°€ ë‚œë‹¤.";
  return "ë‚¡ê³  ë„ˆëœë„ˆëœí•˜ì§€ë§Œâ€¦ ì–´ì©ì§€ ì†ì—ì„œ ë†“ê¸° ì‹«ë‹¤.";
}

const TIERS = [
  { tier:"ì¼ë°˜", p:0.82, powerMult:1.00, valueMult:1.00 },
  { tier:"íŠ¹ìˆ˜", p:0.15, powerMult:1.01, valueMult:1.60 },
  { tier:"ê³ ê¸‰", p:0.03, powerMult:1.04, valueMult:2.20 }
];
function pickTierByRelic(grade){
  let w = { "ì¼ë°˜": 0.82, "íŠ¹ìˆ˜": 0.15, "ê³ ê¸‰": 0.03 };
  if(grade==="ë¹›ë°”ëœ") w = { "ì¼ë°˜": 0.72, "íŠ¹ìˆ˜": 0.23, "ê³ ê¸‰": 0.05 };
  if(grade==="ë´‰ì¸ëœ") w = { "ì¼ë°˜": 0.55, "íŠ¹ìˆ˜": 0.30, "ê³ ê¸‰": 0.15 };
  const r = Math.random();
  const a = w["ì¼ë°˜"];
  const b = a + w["íŠ¹ìˆ˜"];
  const tierName = (r < a) ? "ì¼ë°˜" : (r < b) ? "íŠ¹ìˆ˜" : "ê³ ê¸‰";
  return TIERS.find(t=>t.tier===tierName) || TIERS[0];
}

const TYPE_TABLE = [
  { type:"ëŒ€ê²€", basePower:[98,104], baseValue:[950,1050] },
  { type:"í•œì†ê²€", basePower:[96,102], baseValue:[950,1050] },
  { type:"í™œ", basePower:[95,101], baseValue:[950,1050] },
  { type:"ì°½", basePower:[96,102], baseValue:[950,1050] },
  { type:"ë„ë¼", basePower:[97,103], baseValue:[950,1050] },
  { type:"ë‘”ê¸°", basePower:[97,103], baseValue:[950,1050] }
];
const HUMOR_TYPES = [
  { type:"ë¹ ë£¨", basePower:[96,102], baseValue:[1000,1200] },
  { type:"ìš”ìˆ ë´‰", basePower:[94,100], baseValue:[900,1100] },
  { type:"íŒ”ë£¨ìŠ¤í‹°í”„ê²½", basePower:[95,101], baseValue:[1100,1400] },
  { type:"ë ˆì´ì €ì´", basePower:[93,99], baseValue:[1200,1600] }
];
function maybeHumorReplace(tier){
  const baseChance = 0.02;
  const extra = (tier.tier === "ê³ ê¸‰") ? 0.03 : 0.0;
  if(roll(baseChance + extra)) return choice(HUMOR_TYPES);
  return null;
}
function generateWeapon({ relicGrade="ë‚¡ì€" } = {}){
  const tier = pickTierByRelic(relicGrade);
  const humor = maybeHumorReplace(tier);
  const tinfo = humor ? humor : choice(TYPE_TABLE);
  const bp = randInt(tinfo.basePower[0], tinfo.basePower[1]);
  const bv = randInt(tinfo.baseValue[0], tinfo.baseValue[1]);

  let valueMultBonus = 1.0;
  let optionText = "";
  if(tier.tier === "íŠ¹ìˆ˜" && roll(0.5)){
    const opt = choice([{name:"ê¸ˆë‹ˆ ë°•í˜",mult:1.15},{name:"ìƒì ì£¼ê°€ ì¢‹ì•„í•¨",mult:1.25},{name:"ë„ë‚œí’ˆ ë”±ì§€",mult:1.40}]);
    valueMultBonus = opt.mult; optionText = opt.name;
  }

  const w = {
    id: uuid(),
    type: tinfo.type,
    tier: tier.tier,
    enhance: 0,
    basePower: Math.round(bp * tier.powerMult),
    baseValue: Math.round(bv * tier.valueMult * valueMultBonus),
    optionText,
    relicGrade,
    attr: null,
    nameHistory: null,
    displayName: "",
    createdAt: Date.now()
  };
  updateDisplayName(w);
  return w;
}

/* Dig */
const DIG_COST = 5000;
function canPay(cost){ return state.gold >= cost; }
function dig(){
  const emptyIdx = state.inventory.findIndex(x => x === null);
  if(emptyIdx < 0){
    showModal("ë°œêµ´ ë¶ˆê°€", "ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ë‹¤!", "ë¬´ê¸°ë¥¼ íŒ”ê±°ë‚˜(íŒë§¤) / í„°ëœ¨ë¦° ë’¤ ë‹¤ì‹œ ë°œêµ´í•  ìˆ˜ ìˆì–´.", "DIG");
    return;
  }
  if(!canPay(DIG_COST)){
    showModal("ê³¨ë“œ ë¶€ì¡±", "ê³¨ë“œê°€ ë¶€ì¡±í•´â€¦", `í•„ìš”: ${fmt(DIG_COST)}G`, "DIG");
    return;
  }
  state.gold -= DIG_COST;

  const relic = rollRelicGrade();
  const relicText = relicFlavorText(relic.grade);
  const w = generateWeapon({ relicGrade: relic.grade });
  state.inventory[emptyIdx] = w;

  appendChat({ time: nowHHMM(), kind:"system", text:`â›ï¸ ë°œêµ´: (${relic.grade} ìœ ë¬¼) [${w.tier}] ${w.displayName} íšë“! (ìŠ¬ë¡¯ ${emptyIdx+1})` });
  maybeReaction();

  showModal("ìœ ë¬¼ ë°œêµ´",
    `${relicText}\n${relic.grade} ìœ ë¬¼ì—ì„œ â€œ${relic.relicName}â€ë¥¼ ë°œê²¬í–ˆë‹¤!`,
    `ê°ì • ê²°ê³¼: [${w.tier}] ${w.displayName}\nì†ì„±: ${w.attr} Â· íƒ€ì…: ${w.type}`,
    relic.grade.toUpperCase()
  );

  saveState(); render();
}

/* Enhance */
function enhanceCost(currentPlus){
  const base = [10,20,50];
  const k = Math.floor(currentPlus / 3);
  const r = currentPlus % 3;
  return base[r] * (10 ** k);
}
const PROB = [
  {s:75,k:22,b:3},{s:72,k:23,b:5},{s:69,k:24,b:7},{s:66,k:25,b:9},{s:63,k:26,b:11},
  {s:60,k:27,b:13},{s:55,k:29,b:16},{s:50,k:31,b:19},{s:45,k:33,b:22},{s:40,k:35,b:25},
  {s:35,k:37,b:28},{s:32,k:39,b:29},{s:29,k:41,b:30},{s:26,k:43,b:31},{s:24,k:44,b:32},
  {s:22,k:45,b:33},{s:20,k:46,b:34},{s:18,k:47,b:35},{s:16,k:49,b:35},{s:15,k:50,b:35},
  {s:14,k:51,b:35},{s:13,k:52,b:35},{s:12,k:53,b:35},{s:11,k:54,b:35},{s:10,k:55,b:35},
  {s:9,k:56,b:35},{s:8,k:57,b:35},{s:7,k:58,b:35},{s:7,k:58,b:35},{s:6,k:59,b:35},{s:5,k:60,b:35}
];
function rollEnhanceResult(enh){
  const p = PROB[Math.min(enh, 30)];
  const r = Math.random()*100;
  if(r < p.s) return "SUCCESS";
  if(r < p.s + p.k) return "KEEP";
  return "BREAK";
}
function scrapOnBreak(enh){ if(enh < 10) return 1; if(enh < 20) return 2; return 3; }

let lastWorldPostAt = 0;
const WORLD_COOLDOWN_MS = 900;
function postEnhanceWorldLog({ nickname, tierLabel, weaponName, oldEnhance, newEnhance, result }){
  const t = nowHHMM();
  const now = Date.now();
  if(result === "KEEP") return;
  if(now - lastWorldPostAt < WORLD_COOLDOWN_MS) return;
  lastWorldPostAt = now;

  if(result === "SUCCESS" && newEnhance >= 10){
    appendChat({ time:t, kind:"success", text:`ğŸ‰ [ê°•í™”ì„±ê³µ] ${nickname}ë‹˜ì´ [${tierLabel}] ${weaponName}ì„(ë¥¼) +${oldEnhance} â†’ +${newEnhance} ê°•í™”!` });
    maybeReaction();
  }
  if(result === "BREAK" && oldEnhance >= 10){
    const sc = scrapOnBreak(oldEnhance);
    appendChat({ time:t, kind:"break", text:`ğŸ’¥ [ê°•í™”í„°ì§] ${nickname}ë‹˜ì˜ [${tierLabel}] ${weaponName}(+${oldEnhance}) ì‚°í™”â€¦ (ê³ ì² ì¡°ê° +${sc})` });
    maybeReaction();
  }
}

function enhanceSelected(){
  const idx = state.selectedSlot;
  const w = state.inventory[idx];
  if(!w){ showModal("ê°•í™”", "ìŠ¬ë¡¯ì´ ë¹„ì–´ìˆì–´!", "ê°•í™”í•  ë¬´ê¸°ê°€ ì—†ì–´.", "ENHANCE"); return; }

  const cost = enhanceCost(w.enhance);
  if(!canPay(cost)){ showModal("ê°•í™”", "ê³¨ë“œê°€ ë¶€ì¡±í•´â€¦", `í•„ìš”: ${fmt(cost)}G`, "ENHANCE"); return; }

  state.gold -= cost;
  const old = w.enhance;
  const result = rollEnhanceResult(old);

  if(result === "SUCCESS"){
    w.enhance += 1;
    updateDisplayName(w);
    appendChat({ time: nowHHMM(), kind:"system", text:`âœ¨ ê°•í™” ì„±ê³µ! +${old} â†’ +${w.enhance} (ë¹„ìš© -${fmt(cost)}G)` });
    showModal("ê°•í™” ì„±ê³µ", `+${old} â†’ +${w.enhance}`, `ë¬´ê¸°ëª…: ${w.displayName}\nì†ì„±: ${w.attr}`, "SUCCESS");
    postEnhanceWorldLog({ nickname: state.me.nickname, tierLabel: w.tier, weaponName: w.displayName, oldEnhance: old, newEnhance: w.enhance, result:"SUCCESS" });
  } else if(result === "KEEP"){
    appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ˜¶ ê°•í™” ìœ ì§€â€¦ (+${old} ê·¸ëŒ€ë¡œ) (ë¹„ìš© -${fmt(cost)}G)` });
    showModal("ê°•í™” ìœ ì§€", `+${old} ìœ ì§€`, `ë¬´ê¸°ëª…: ${w.displayName}`, "KEEP");
  } else {
    const sc = scrapOnBreak(old);
    state.scrap += sc;
    state.inventory[idx] = null;
    appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ’¥ ê°•í™” ì‹¤íŒ¨! ë¬´ê¸°ê°€ ì‚°í™”â€¦ (ê³ ì²  +${sc}) (ë¹„ìš© -${fmt(cost)}G)` });
    showModal("ê°•í™” ì‹¤íŒ¨", "ë¬´ê¸°ê°€ ì‚°í™”í–ˆë‹¤â€¦", `ê³ ì²  +${sc}`, "BREAK");
    postEnhanceWorldLog({ nickname: state.me.nickname, tierLabel: w.tier, weaponName: w.displayName, oldEnhance: old, result:"BREAK" });
  }

  saveState(); render();
}

/* Sell */
function sellSelected(){
  const idx = state.selectedSlot;
  const w = state.inventory[idx];
  if(!w){ showModal("íŒë§¤", "íŒ” ë¬´ê¸°ê°€ ì—†ì–´!", "", "SELL"); return; }
  const sale = Math.round(w.baseValue * (1 + w.enhance * 0.12));
  state.gold += sale;
  appendChat({ time: nowHHMM(), kind:"system", text:`ğŸ·ï¸ íŒë§¤: [${w.tier}] ${w.displayName}(+${w.enhance}) â†’ +${fmt(sale)}G` });
  showModal("íŒë§¤ ì™„ë£Œ", `+${fmt(sale)}G`, `${w.displayName} (ì†ì„±: ${w.attr})`, "SELL");
  state.inventory[idx] = null;
  saveState(); render();
}

/* PVP */
const PVP_BASE_REWARD = 4000;
function tierMultGold(tierLabel){ if(tierLabel==="íŠ¹ìˆ˜") return 1.4; if(tierLabel==="ê³ ê¸‰") return 1.8; return 1.0; }
function enhanceMultGold(oppEnhance){ return 1 + 0.10 * Math.max(0, oppEnhance - 1); }
function computePvpWinReward({ oppEnhance, oppTierLabel }){ return Math.round(PVP_BASE_REWARD * enhanceMultGold(oppEnhance) * tierMultGold(oppTierLabel)); }
function tierMultPower(tierLabel){ if(tierLabel==="íŠ¹ìˆ˜") return 1.01; if(tierLabel==="ê³ ê¸‰") return 1.04; return 1.0; }
function enhanceMultPower(enh){ return 1 + 0.04 * enh; }
function computePower({ basePower, enhance, tierLabel }){ return basePower * enhanceMultPower(enhance) * tierMultPower(tierLabel); }
function computeWinProb(myPower, oppPower){
  const ratio = (myPower - oppPower) / (myPower + oppPower);
  let p = 0.5 + ratio * 0.90;
  return clamp(0.20, p, 0.80);
}
function loadFriends(){ try{ const raw=localStorage.getItem(FRIENDS_KEY); return raw?JSON.parse(raw):[]; }catch{ return []; } }
function saveFriends(list){ localStorage.setItem(FRIENDS_KEY, JSON.stringify(list)); }
function buildOpponentPool(){
  const friends = loadFriends();
  return [...friends, ...(state.npcs||[])];
}
let lastOppNickname = null;
function pickRandomOpponent(pool){
  if(!pool.length) return null;
  let opp = pool[Math.floor(Math.random()*pool.length)];
  if(pool.length>=2 && opp.nickname===lastOppNickname){
    let tries=3;
    while(tries-- > 0 && opp.nickname===lastOppNickname){
      opp = pool[Math.floor(Math.random()*pool.length)];
    }
  }
  lastOppNickname = opp.nickname;
  return opp;
}
function simulatePvp(){
  const w = state.inventory[state.selectedSlot];
  if(!w){ showModal("PVP", "PVPí•  ë¬´ê¸°ê°€ ì—†ì–´!", "ìŠ¬ë¡¯ì— ë¬´ê¸°ê°€ ìˆì–´ì•¼ í•´.", "PVP"); return; }

  const pool = buildOpponentPool();
  const opp = pickRandomOpponent(pool);
  if(!opp){ showModal("PVP", "ìƒëŒ€ í’€ì´ ë¹„ì—ˆì–´!", "ì¹œêµ¬ë¥¼ ë“±ë¡í•˜ê±°ë‚˜ NPCë¥¼ ê¸°ë‹¤ë ¤ì¤˜.", "PVP"); return; }

  const myPower = computePower({basePower:w.basePower, enhance:w.enhance, tierLabel:w.tier});
  const oppPower = computePower({basePower:opp.basePower, enhance:opp.enhance, tierLabel:opp.tierLabel});
  const winProb = computeWinProb(myPower, oppPower);
  const win = Math.random() < winProb;

  if(win){
    state.pvp.wins += 1;
    state.pvp.winStreak += 1;
    const reward = computePvpWinReward({ oppEnhance: opp.enhance, oppTierLabel: opp.tierLabel });
    state.gold += reward;
    appendChat({ time: nowHHMM(), kind:"system", text:`âœ… PVP ìŠ¹ë¦¬! (${Math.round(winProb*100)}% í™•ë¥ ) +${fmt(reward)}G` });
    if(opp.enhance >= 10 || opp.tierLabel==="ê³ ê¸‰" || reward >= 8000 || [3,5,7,10].includes(state.pvp.winStreak)){
      appendChat({ time: nowHHMM(), kind:"system", text:`âš”ï¸ [PVPìŠ¹ë¦¬] ${state.me.nickname} (${w.displayName} +${w.enhance}) â†’ ${opp.nickname}ì˜ [${opp.tierLabel}] ${opp.weaponName}(+${opp.enhance}) ê²©íŒŒ! ë³´ìƒ +${fmt(reward)}G (ì—°ìŠ¹ ${state.pvp.winStreak})` });
      maybeReaction();
    }
    showModal("PVP ìŠ¹ë¦¬", `+${fmt(reward)}G`, `${opp.nickname} [${opp.tierLabel}] +${opp.enhance} ìƒëŒ€ë¡œ ìŠ¹ë¦¬!`, "PVP");
  }else{
    state.pvp.losses += 1;
    state.pvp.winStreak = 0;
    appendChat({ time: nowHHMM(), kind:"system", text:`âŒ PVP íŒ¨ë°°â€¦ (${Math.round(winProb*100)}% í™•ë¥ ) ë³´ìƒ 0G` });
    showModal("PVP íŒ¨ë°°", "ë³´ìƒ 0G", `${opp.nickname}ì—ê²Œ ì¡Œë‹¤â€¦`, "PVP");
  }
  saveState(); render();
}

/* Friends UI */
function renderFriendsList(){
  const el = $("friendsList");
  const list = loadFriends();
  if(list.length === 0){
    el.innerHTML = `<div class="mini" style="opacity:.75">ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ í¼ì—ì„œ ì¶”ê°€í•´ì¤˜!</div>`;
    return;
  }
  el.innerHTML = list.map((f, idx) => `
    <div class="friend-card">
      <div>
        <div class="friend-line1">${escapeHtml(f.nickname)}</div>
        <div class="friend-line2">[${escapeHtml(f.tierLabel)}] ${escapeHtml(f.weaponName)} (+${f.enhance})</div>
        <div class="friend-line3">basePower ${f.basePower}${f.note?(" Â· "+escapeHtml(f.note)):""}</div>
      </div>
      <div class="friend-actions">
        <button class="btn small" data-action="edit" data-idx="${idx}">ìˆ˜ì •</button>
        <button class="btn small danger" data-action="delete" data-idx="${idx}">ì‚­ì œ</button>
      </div>
    </div>
  `).join("");
  el.querySelectorAll("button[data-action]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const action = btn.dataset.action;
      const idx = Number(btn.dataset.idx);
      if(action==="delete"){
        const list = loadFriends();
        list.splice(idx,1);
        saveFriends(list);
        renderFriendsList();
      }else{
        const f = loadFriends()[idx];
        $("fNick").value = f.nickname;
        $("fWeapon").value = f.weaponName;
        $("fTier").value = f.tierLabel;
        $("fEnh").value = f.enhance;
        $("fBase").value = f.basePower;
        $("fNote").value = f.note || "";
        $("friendForm").dataset.editing = String(idx);
        toast("ìˆ˜ì • ëª¨ë“œ");
      }
    });
  });
}
$("friendForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const friend = {
    nickname: $("fNick").value.trim().slice(0,12),
    weaponName: $("fWeapon").value.trim().slice(0,18),
    tierLabel: $("fTier").value,
    enhance: clamp(0, Number($("fEnh").value||0), 30),
    basePower: clamp(80, Number($("fBase").value||100), 140),
    note: $("fNote").value.trim().slice(0,24)
  };
  if(!friend.nickname || !friend.weaponName){ toast("ë‹‰/ë¬´ê¸°ëª…ì„ ì±„ì›Œì¤˜!"); return; }
  const list = loadFriends();
  const editing = $("friendForm").dataset.editing;
  if(editing !== undefined && editing !== ""){
    list[Number(editing)] = friend;
    delete $("friendForm").dataset.editing;
    toast("ìˆ˜ì • ì™„ë£Œ!");
  }else{
    list.push(friend);
    toast("ì¹œêµ¬ ì¶”ê°€!");
  }
  saveFriends(list);
  $("friendForm").reset();
  $("fEnh").value = 1;
  $("fBase").value = 100;
  renderFriendsList();
});
$("exportFriends").addEventListener("click", async ()=>{
  const data = JSON.stringify(loadFriends(), null, 2);
  try{ await navigator.clipboard.writeText(data); toast("í´ë¦½ë³´ë“œì— ë³µì‚¬!"); }
  catch{ prompt("ë³µì‚¬í•´ì„œ ì €ì¥í•´ì¤˜:", data); }
});
$("importFriends").addEventListener("click", ()=>{
  const json = prompt("ë¶™ì—¬ë„£ì„ ì¹œêµ¬ ëª©ë¡ JSON:");
  if(!json) return;
  try{
    const list = JSON.parse(json);
    if(!Array.isArray(list)) throw 0;
    const normalized = list.map(x=>({
      nickname:String(x.nickname||"ìµëª…").slice(0,12),
      weaponName:String(x.weaponName||"ê²€").slice(0,18),
      tierLabel:(["ì¼ë°˜","íŠ¹ìˆ˜","ê³ ê¸‰"].includes(x.tierLabel)?x.tierLabel:"ì¼ë°˜"),
      enhance:clamp(0, Number(x.enhance||1), 30),
      basePower:clamp(80, Number(x.basePower||100), 140),
      note:String(x.note||"").slice(0,24)
    }));
    saveFriends(normalized);
    renderFriendsList();
    toast("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!");
  }catch{
    toast("JSON í˜•ì‹ì´ ì´ìƒí•´!");
  }
});
$("resetFriends").addEventListener("click", ()=>{
  if(!confirm("ì¹œêµ¬ë¥¼ ì „ë¶€ ì‚­ì œí• ê¹Œ?")) return;
  saveFriends([]);
  renderFriendsList();
  toast("ì „ì²´ ì‚­ì œ!");
});

/* UI bindings */
$("btnCafeteria").addEventListener("click", claimCafeteria);
$("btnDig").addEventListener("click", dig);
$("btnPvp").addEventListener("click", simulatePvp);
$("btnEnhance").addEventListener("click", enhanceSelected);
$("btnSell").addEventListener("click", sellSelected);
$("btnSwitch").addEventListener("click", ()=>{ state.selectedSlot = state.selectedSlot===0?1:0; saveState(); render(); });
$("slot0").addEventListener("click", ()=>{ state.selectedSlot=0; saveState(); render(); });
$("slot1").addEventListener("click", ()=>{ state.selectedSlot=1; saveState(); render(); });
$("btnReset").addEventListener("click", ()=>{
  if(!confirm("ì„¸ì´ë¸Œë¥¼ ì´ˆê¸°í™”í• ê¹Œ? (ë¡œì»¬ ì €ì¥)")) return;
  localStorage.removeItem(SAVE_KEY);
  state = defaultState();
  $("chatLog").innerHTML = "";
  appendChat({ time: nowHHMM(), kind:"system", text:"ì„¸ì´ë¸Œ ì´ˆê¸°í™” ì™„ë£Œ. ë‹¤ì‹œ ì‹œì‘!" });
  saveState(); render();
});

/* Render */
function renderTop(){
  $("gold").textContent = fmt(state.gold);
  $("scrap").textContent = fmt(state.scrap);
  $("pvpStat").textContent = `${state.pvp.wins}W-${state.pvp.losses}L`;
  $("streak").textContent = state.pvp.winStreak;
}
function renderCafeteria(){
  const st = cafeteriaStatus();
  $("cafeteriaInfo").textContent = `ìµœê·¼24h ë‚¨ì€ ê¸‰ì‹ ${st.remaining}/4 Â· ë‹¤ìŒê¹Œì§€ ${fmtMs(st.nextIn)}`;
  $("btnCafeteria").disabled = !st.can;
}
function renderSlots(){
  function setSlot(prefix, w, idx){
    if(w) updateDisplayName(w);
    $(prefix+"Name").textContent = w ? `[${w.tier}] ${w.displayName}` : "â€” ë¹„ì–´ìˆìŒ â€”";
    $(prefix+"Meta").textContent = w ? `+${w.enhance} Â· ${w.type} Â· ì†ì„± ${w.attr} Â· basePower ${w.basePower}` : "ë°œêµ´í•´ì„œ ë¬´ê¸°ë¥¼ ë„£ì–´ì¤˜!";
    const cost = w ? enhanceCost(w.enhance) : 0;
    $(prefix+"Meta2").textContent = w ? `íŒë§¤ê°€ ì˜ˆìƒ: ${fmt(Math.round(w.baseValue*(1+w.enhance*0.12)))}G Â· ë‹¤ìŒ ê°•í™”ë¹„ìš©: ${fmt(cost)}G` : "â€”";
    const box = $(idx===0 ? "slot0" : "slot1");
    box.classList.toggle("active", state.selectedSlot===idx);
  }
  setSlot("slot0", state.inventory[0], 0);
  setSlot("slot1", state.inventory[1], 1);
  $("selectedSlotLabel").textContent = state.selectedSlot===0 ? "ìŠ¬ë¡¯ 1" : "ìŠ¬ë¡¯ 2";
}
function render(){
  renderTop();
  renderCafeteria();
  renderSlots();
  renderFriendsList();
  saveState();
}

/* init */
appendChat({ time: nowHHMM(), kind:"system", text:"ì›”ë“œ ì±„íŒ…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤." });
render();
</script>
</body>
</html>
