<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>정화일 (Dies lustrationis) — 프로토타입</title>
  <style>
  :root{
    --bg:#0b0c10;
    --panel:#12141b;
    --text:#e7e9f0;
    --muted:#a7adbd;
    --line:#242a3a;
    --accent:#7aa2ff;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",system-ui,sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  header{
    position:sticky; top:0; z-index:10;
    background:rgba(11,12,16,.92);
    backdrop-filter:blur(10px);
    border-bottom:1px solid var(--line);
    padding:12px 14px;
  }
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .pill{
    border:1px solid var(--line);
    background:var(--panel);
    color:var(--muted);
    padding:6px 10px;
    border-radius:999px;
    font-size:13px;
  }
  .pill strong{ color:var(--text); font-weight:700; }
  .pill.countdown{
    border-color:rgba(122,162,255,.45);
    background:rgba(122,162,255,.14);
    color:var(--text);
  }
  .wrap{ max-width:920px; margin:0 auto; padding:14px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px; }
  #text{ white-space:pre-wrap; line-height:1.65; font-size:16px; }
  #title{ font-size:13px; color:var(--muted); margin:0 0 8px 0; }
  .choices{ display:grid; gap:10px; margin-top:14px; }
  button{
    appearance:none;
    border:1px solid var(--line);
    background:#0f1220;
    color:var(--text);
    padding:12px;
    border-radius:12px;
    text-align:left;
    font-size:15px;
    line-height:1.35;
    cursor:pointer;
  }
  button:hover{ border-color:rgba(122,162,255,.6); }
  button:active{ transform:translateY(1px); }
  .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  .small{ font-size:13px; color:var(--muted); }
  .ghost{ opacity:.85; }
  dialog{
    border:1px solid var(--line);
    border-radius:14px;
    background:var(--panel);
    color:var(--text);
    max-width:920px;
    width:calc(100% - 20px);
  }
  dialog::backdrop{ background:rgba(0,0,0,.55); }
  dialog h3{ margin:0 0 8px 0; }
  dialog .content{ white-space:pre-wrap; line-height:1.6; }
  dialog .footer{ margin-top:12px; display:flex; gap:10px; justify-content:flex-end; }
  .btn{ background:#0f1220; }
  .btn.primary{ border-color:rgba(122,162,255,.65); }
</style>
</head>
<body>
  <header>
  <div class="topbar">
    <div class="row">
      <div class="pill">이름: <strong id="statName">—</strong></div>
      <div class="pill">Day: <strong id="statDay">0</strong></div>
      <div class="pill">체력: <strong id="statHP">3/5</strong></div>
      <div class="pill">허기: <strong id="statHunger">3/5</strong></div>
      <div class="pill">식량: <strong id="statFood">0</strong></div>
      <div class="pill">돈: <strong id="statMoney">0</strong></div>
      <div class="pill">MAM: <strong id="statMAM">없음</strong></div>
      <div class="pill">수첩: <strong id="statNotebook">없음</strong></div>
    </div>
    <div class="row">
      <div class="pill countdown" id="statCountdown" style="display:none">다음 정화일 D-?</div>
    </div>
  </div>
</header>

  <main class="wrap">
    <div class="card">
      <div id="title"></div>
      <div id="text"></div>
      <div class="choices" id="choices"></div>

      <div class="toolbar">
        <button class="btn" id="btnNotebook">수첩</button>
        <button class="btn" id="btnSave">저장</button>
        <button class="btn" id="btnLoad">불러오기</button>
        <button class="btn" id="btnEat">식사</button>
        <button class="btn" id="btnRest">휴식</button>
        <button class="btn" id="btnReset">초기화</button>
      </div>

      <div class="small ghost" style="margin-top:10px;">
        모바일 Safari에서 바로 실행되는 단일 HTML 프로토타입입니다. (스토리/노드/선택지 테스트용)
      </div>
    </div>
  </main>

  <dialog id="dlgNotebook">
    <div class="wrap" style="padding:14px;">
      <h3>수첩</h3>
      <div class="content" id="notebookContent"></div>
      <div class="footer">
        <button class="btn primary" id="btnCloseNotebook">닫기</button>
      </div>
    </div>
  </dialog>

<script>

const state = {
  nodeId: "PROLOGUE",
  day: 0,
  maxHp: 5,
  playerName: null,
  hp: 3,
  hunger: 3,
  maxHunger: 5,
  food: 0,
  money: 0,
  mam: { level: 0, label: "없음" },
  inventory: [],
  notebookEntries: [],
  flags: { hasNotebook: false, signedLustra: false }
  ,purification: { known:false, daysRemaining:null }
};

function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
function addItem(name){ if (!state.inventory.includes(name)) state.inventory.push(name); }
function addNotebookEntry(title, body){
  state.notebookEntries.push({ title, body, at: new Date().toISOString() });
  state.flags.hasNotebook = true;
  addItem("수첩");
}
function addFood(n=1){
  if(typeof state.food !== "number") state.food = 0;
  state.food = Math.max(0, state.food + Number(n||0));
}
function eat(){
  const maxH = Number(state.maxHunger ?? 5);
  if((state.food ?? 0) <= 0){
    toast("먹을 것이 없다.");
    return;
  }
  state.food -= 1;
  state.hunger = clamp(Number(state.hunger ?? 0) + 2, 0, maxH);
  render();
  toast("식사했다. (허기 +2)");
}


function ensurePurificationDefaults(){
  if(!state.purification) state.purification = { known:false, daysRemaining:3 };
  if(typeof state.purification.known !== "boolean") state.purification.known = false;
  if(state.purification.daysRemaining === null) state.purification.daysRemaining = 3;
  if(typeof state.purification.daysRemaining !== "number") state.purification.daysRemaining = 3;
}
function learnPurificationCountdown(days){
  ensurePurificationDefaults();
  state.purification.known = true;
  state.purification.daysRemaining = clamp(Number(days ?? 0), 0, 999);
}
function advanceDays(n=1){
  ensurePurificationDefaults();
  if(typeof state.purification.daysRemaining !== "number") return;
  state.purification.daysRemaining = Math.max(0, state.purification.daysRemaining - Math.max(0, Number(n)||0));
}
function updateStats(){
  document.getElementById("statName").textContent = state.playerName ?? "—";
  const dayEl = document.getElementById("statDay");
  if(dayEl) dayEl.textContent = String(state.day ?? 0);
  document.getElementById("statHP").textContent = `${state.hp}/${state.maxHp}`;
  const maxH = Number(state.maxHunger ?? 5);
  const h = clamp(Number(state.hunger ?? 0), 0, maxH);
  document.getElementById("statHunger").textContent = `${h}/${maxH}`;
  document.getElementById("statFood").textContent = Number(state.food ?? 0);
  document.getElementById("statMoney").textContent = state.money;
  document.getElementById("statMAM").textContent = state.mam.label;
  document.getElementById("statNotebook").textContent = state.flags.hasNotebook ? "있음" : "없음";
  // Countdown: shows only after player learns the schedule
  ensurePurificationDefaults();
  const cd = document.getElementById("statCountdown");
  if(state.purification.known && typeof state.purification.daysRemaining === "number"){
    cd.style.display = "";
    cd.textContent = `다음 정화일 D-${state.purification.daysRemaining}`;
  } else {
    cd.style.display = "none";
  }
}
function saveGame(){
  localStorage.setItem("dies_lustrationis_save_v1", JSON.stringify(state));
  toast("저장했습니다.");
}
function loadGame(){
  const raw = localStorage.getItem("dies_lustrationis_save_v1");
  if(!raw) return toast("저장 데이터가 없습니다.");
  const data = JSON.parse(raw);
  Object.assign(state, data);
  ensurePurificationDefaults();
  toast("불러왔습니다.");
  ensurePurificationDefaults();
render();
}
function resetGame(){
  localStorage.removeItem("dies_lustrationis_save_v1");
  location.reload();
}

function resetRun(){
  // '처음으로' 버튼용: 페이지 리로드 없이 런(상태)만 초기화
  state.nodeId = "PROLOGUE";
  state.hp = 3;
  state.maxHp = Number(state.maxHp ?? 5);
  state.money = 0;
  state.hunger = 0;
  state.inventory = [];
  state.mam = { level: 0 };
  state.flags = { hasNotebook: false };
  state.purification = { known: false, daysRemaining: 3 };
  ensurePurificationDefaults();
  toast("새 게임을 시작합니다.");
  render();
}

const NODES = {
  PROLOGUE: {
    title: "프롤로그",
    text:
`장대와도 같은 비가 검은 하늘 아래로 쏟아져 내린다.
잿빛의 하늘, 끊기지 않는 총성과도 같은 빗소리가 고막을 두들긴다.

이 비는 기억을 지운다.

당신은 이 폭우 속에서 기억이 지워져내렸다.
목에 걸린 1등급 기억보존 장치가 기긱거리는 소음을 내며 작동한다.
깨져있는 모습을 보아하니, 작동하는 것만으로도 감사할 지경이다.

언어. 사회규범. 숨 쉬는 법. 걷는 법. 인사하는 법.
그 외의 것은… 없다.

저 멀리서 경비 드론이 당신을 발견하고 다가온다.

드론 : 현재 정화작업으로, 인공강우가 내리고 있습니다.
시민 여러분께서는 즉시 귀가하시기 바랍니다.
불응할 시, 귀하의 1등급 기억 보존 장치를 제시하여 신분을 증명해주시기 바랍니다.`,
    choices: [
      { label: "ㅇ 기억보존장치를 제시한다.", to: "A_SCAN" },
      { label: "ㅇ 도망친다.", to: "B_RUN_START" }
    ]
  },

  A_SCAN: {
    title: "정화일 A루트",
    text:
`당신은 드론의 스캐너 앞에 착용하고 있던 기억보존장치를 제시한다.
강렬한 스캔 레이저가 눈앞을 스쳐 지나간다.

드론 : 스캔이 완료되었으나, 오류로 인하여 등록정보를 확인할 수 없었습니다.
소지하고 계신 기억보존장치는 본인 소유의 물건이 맞으십니까?

…선택지는 없다는 걸 직감한다.

드론 : 주민 재심사장으로 이동하여 재등록하실 것을 권장드립니다. 동의하십니까?`,
    choices: [
      { label: "ㅇ (고개를 끄덕인다.)", to: "A_RESCREEN_NOTEBOOK" }
    ]
  },

  A_RESCREEN_NOTEBOOK: {
    title: "주민등록 재심사장",
    text:
`드론을 따라 도착한 곳은 주민등록 재심사장이었다.
폭우 속을 쉬지 않고 걸은 탓에, 온 몸은 물먹은 스펀지처럼 푹 젖어있었지만, 입 안쪽은 까끌까끌했다. 당신은 갈증을 느끼며 이 어이없는 상황에 기이함을 체험했다.

비교적 밝고 깨끗한, 대리석으로 만들어진 바닥에 홀로 서 있는 자신의 몰골을 깨닫고는 조금 비참한 기분을 느꼈다.

어이없게도 드론은 당신에게 사람이 인사하듯 고개를 꾸벅 숙이고는 다시 비가 내리는 바깥으로 이동했다. 당신도 뒤늦게나마 어색하게 고개를 숙였다.

이곳을 찾는 사람은 많지 않았다.
아마도, 당신처럼 어떤 이유로든간에 기억보존장치가 파손되었거나, 분실된 사람들일 것이다.

카운터에 서있는 직원이 기묘하게 밝은 얼굴로 당신을 맞이하며 인사를 건넨다.
당신은 왠지 잘못한 어린아이처럼 쭈뼛거린다.

직원 : 안녕하세요, 주민등록 재심사 대상자시군요? 가지고 계신 기억보존장치를 보여주실 수 있으실까요?

직원은 상냥하게 당신의 신분을 확인하려 한다.
당신은 파손된 안쪽으로 물이 차서 찰랑거리는 소리가 나는 기억보존장치를 들어 지저분한 손으로 직원에게 건넨다.
직원은 꺼려하는 기색 없이 당신의 장치를 들어 자세히 살펴보고는 안내한다.

직원 : 아.. 이런, 기억보존장치가 파손되셨네요.. 괜찮습니다! 파손이나 분실로 찾아오시는 분들이 이렇게 종종 있으시거든요! 수첩 같은 개인 기록물을 주셔도 확인할 수 있으니 한 번 찾아보시겠어요?

그제서야 당신은 개인 소지품을 통해 자신을 추측할 수 있음을 깨닫고는 주섬주섬 주머니를 뒤지기 시작한다.
물에 젖어 엉망진창이 된 수첩 한 권이 안 주머니에서 나온다.

이 수첩은 열어보지 않는 편이 좋을 듯 하다.

직원 : 아.. 하하, 이거 참 곤란하게 되었네요. 괜찮습니다. 저기 옆 쪽으로 가시면 [루스트라 교단 기억 구제국] 창구가 있거든요. 관청과 협의해서 무료로 임시 기억보존장치를 대여하거나 "무상"으로 제공해드리고 있으니, 우선 임시 신분을 신고하신 후에 본래 신분으로 이전하시면 되니까요. 아무리 저렴한 기억보존장치라고 해도, 이렇게 무상으로 제공하시다니, 정말 상냥한 분들이라니까요.

당신은 직원의 안내로 옆 창구의 하얀 사제복을 입고 있는 교단의 사제에게 다가간다. 곧이어 직원은 당신이 서 있던 자리로 와서 바닥에 괸 빗물을 대걸레로 훔치기 시작한다. 고요하고, 고요하다.

교단의 사제는 조용히 미소를 지으며 옆자리에서 서류 한 장과 당신이 지니고 있던 것의 새 제품인듯한 기억보존장치를 꺼내어 테이블 앞에 내민다. 실로 온화한 미소이다. 종교인은 모두 이런 느낌인가? 라는 의문을 가지며 종이에 손을 내밀던 당신에게 사제는 손바닥을 내민다.

사제 : 종이를 만지시기 전에 손을 닦으시지 않는다면, 이 서류를 두 번 쓰셔야 할겁니다, 형제님.

사제는 가벼운 농을 던지며 테이블 아래의 서랍에서 수건을 꺼내어 건넨다.
당신이 손에 쥔 수건에서는 희미한 온기가 느껴진다. 당신은 깊은 감사를 표하며 우선 손과 얼굴, 머리를 수건으로 닦아낸다.

사제 : 종종 이런 분들이 찾아오시거든요. 자, 별거 아닌 서류니까 보고 밑에 서명만 해주시면 됩니다. 이름이 필요하거든요.

당신은 스스로의 이름을 기억하지는 못하지만, 그렇다고 그것이 서명하지 못할 일은 아님은 알고 있다.

사제 : 본명을 기억하지 못하신다면, 떠오르는 이름을 적으셔도 괜찮습니다.

잠시 사제는 뜸을 들이고는 알 수 없는 미소를 지으며 당신의 시선을 끌어당긴다. 아주 잠깐의 적막 속에서 당신은 옷에서 떨어지는 빗물의 소리를 들었다.

사제 : 그 "이름"이 당신을 의미하도록 만들면 되니까요.

— — —

무상 MAM 복지 수혜 및 기억 구제 지원 동의서 (요약본)

문서번호: LV-SS--
발급기관: 루스트라 신앙 산하 기억구제국 / 도시행정청 협력기관

<핵심 지원 안내>
▶기억보존장치 Memory Authentication Module(이하 MAM)의 기초 기능 무상지원(임시)
▶정화일 규범 준수 의무
▶월 소득 10% 이상 구제 분담금 납부 의무

…(중략)…

서류 맨 하단에는 아주 작은 글씨가 적혀있었다.
눈을 찌푸리고 얼굴을 가까이 하여 읽어보니, 경고 문구가 빼곡하다.

이 복잡한 내용이 무엇을 의미하는지는 잘 모르겠지만, 꽤나 불편한 느낌이 든다.

공간 속에서 펜이 종이를 긁는 소리와 빗방울이 옷자락에서 바닥으로 떨어지는 소리 외에는 모두가 숨을 죽이고 있다.
마치 세계가 당신의 행동 한 프레임 한 프레임을 지켜보는 듯 한 기분이다.

[이름을 입력하세요]
_______(playername)____________

사제 : 임시 등록 서류 작성 완료 되셨구요. playername님, 여기 새 기억보존장치 받으시면 됩니다. 그리고, 이건 도움이 될까 해서 드리는 거에요. 가지고 계시던 건 모두 젖어버리셨으니까 말이죠. 그리고...

— item "수첩" 획득 —

수첩 첫 페이지에는 정갈하게 인쇄된 활자가 적혀있다.
"망각은 순수로의 첫 걸음이다."
(루스트라 기억구제국 배포용)

사제 : 루스트라 교단에 입교하신 것을 환영해요, 형제님.
사제는 오른 손바닥으로 작은 글씨로 적힌 경고 문구를 가리는 듯 한 자세로 서류를 거두어간다.

오싹한 기분이 등줄기를 훑는다.
이름과 기억보존장치라는 작은 기계장치를 대가로, 어마어마한 실수를 저지른 것 같은 기분을 떨칠 수가 없다.

하지만 당신은 그 실수가 어떤 종류인지조차 모른다.`,
    choices: [
      {
        label: "ㅇ 서류를 읽고 서명한다. (이름 입력)",
        action: () => {
          const name = prompt("이름을 입력하세요", state.playerName ?? "");
          if (name && name.trim().length) state.playerName = name.trim();
          state.mam = { level: 1, label: "1층(기초) — 무상" };
          state.flags.signedLustra = true;
          state.flags.hasNotebook = true;
          addItem("수첩");
          addNotebookEntry("수첩 — 첫 페이지", "망각은 순수로의 첫 걸음이다.\n(루스트라 기억구제국 배포용)");
          learnPurificationCountdown(3);
          addFood(1);
          toast("MAM(1층)과 수첩을 받았다. (+식량 1)");
        },
        to: "A_AFTER"
      }
    ]
  },

  A_AFTER: {
    title: "재심사장 밖",
    text:
`당신은 이름을 얻었다.
그리고 무엇인가를 잃었다는 기분이 든다.

…하지만 그 실수가 어떤 종류인지조차 모른다.

(다음: A루트 메인 노드로 이어붙이기)`,
    choices: [
      { label: "ㅇ (테스트 종료) 처음으로", action: resetRun }
    ]
  },

  B_RUN_START: {
    title: "정화일 B루트",
    text:
`당신은 드론의 요구에 응하는 것보다도 본능적인 공포에 몸을 맡겨, 즉시 뒤로 돌아 달음박질했다.

드론 : 검문에 응하지 않을 시, 제압탄 사격이 허용됩니다. 5초 내로 돌아오시기를 권장드립니다.
…3초 내로 돌아오지 않을 시 시민의 안전을 위해 제압탄 사격이 허용됩니다.

무작정 앞으로, 앞으로.
폐부가 찢겨나가는 고통 속에서도 당신은 달린다.

드론 : 2… 1.. 제압탄을 사용합니다.

텅.

당신의 시선은 도시 끝에서 지면을 향한다.
허리에서 강렬한 통증이 느껴진다.
지면에 고여가는 물과 함께, 기억이 흐릿해져간다. 도망쳐야하는 이유는…?
`,
    choices: [
      { label: "ㅇ 고통을 짓이기고 도망친다. (체력-2)", to: "B_ESCAPE", action: () => state.hp = clamp(state.hp - 2, 0, 9) },
      { label: "ㅇ 정신을 잃는다. (체력-1)", to: "B_FAINT", action: () => state.hp = clamp(state.hp - 1, 0, 9) }
    ]
  },

  B_ESCAPE: {
    title: "도주",
    text:
`이유는 몰라도 당신은 지친 몸을 억지로 끌어당겨 일어난다.
드론이 가까워진다.

탕!
드론 : 실탄의 사용이 승인되었습니다.

철창을 넘어선 곳은 가파른 경사로 이루어진 동굴이었다.
당신은 구르고, 굴러 떨어진다.
허벅지에 불이 붙은 것 같은 통증—총상이다.

하지만 당신은 살아남았다.`,
    choices: [
      { label: "ㅇ (카타콤으로) 계속", to: "B_CATACOMB_PLACEHOLDER" }
    ]
  },

  B_FAINT: {
    title: "기절",
    text:
`당신은 실존할지도 모르는 ‘기절할 권리’를 마음속으로 주장하며 정신을 놓아버린다.

땅바닥이 차갑고,
당신을 이끄는 누군가의 팔은 더 차갑다.

(당신은 깨어나게 될 것이다.)`,
    choices: [
      { label: "ㅇ (카타콤으로) 계속", to: "B_CATACOMB_PLACEHOLDER" }
    ]
  },

  B_CATACOMB_PLACEHOLDER: {
    title: "카타콤 — 낯선 빛",
    text:
`눈을 감으면 어둠이 내려앉는다.
당신은 의식을 잃지 못한 채 어둠 속으로 가라앉는 기분을 느낀다.

당신의 머리속에 어떤 종교의 한 구절이 아스라히 펼쳐진다.

"신께서 어둠 중에 이르시되 빛이 있으라 하셨고, 이에 빛이 있었다."

고통에 몸부림치면서도 당신은 빛을 갈구한다.
무거운 눈꺼풀을 들어올렸음에도 어둠이 가득한 곳.

허나, '빛이 있으라'는 구절과 함께 저 멀리서 아주 희미한 빛이 당신에게 다가오기 시작했다.

??? : 어이, 무슨 소리가 났나 했더니 정말 저기 사람이 굴러들어왔잖아?

??? : 어이쿠, 꼴이 엉망이로구만. 세정 강우가 내리는 날에는 이렇게 같이 흘러들어오는 인간들도 종종 있단 말이지.

두 사람의 목소리와 함께.

예의를 아는 사람이라면 응당 일어나 악수나 목례, 혹은 배례를 하겠지만, 당신은 예의를 차릴 수 있는 상태가 아니다.
그나마 인사 대신 건넬 수 있었던 것은 나지막한 신음소리 뿐이었다.

??? : 밖에서 비도 맞고, 기억도 잃고, 온갖 고초를 헤치고 왔다는 늠름한 표정이로구만. 기개가 있어.

??? : 이것 보라고 보리스, 이 녀석 허벅지에 총상까지 있는데? 간덩이가 보통 부은게 아닌걸?

두 남성은 당신을 찬찬히 둘러보며 감상을 말한다.
조금만 더 몸 상태가 멀쩡했다면 당신은 그렇게 구경만 하고 있을 거라면 꺼져줬으면 하는 말을 뱉었을지도 모른다고 생각한다.

보리스 : 뭐? 총상? 어디 어디. 이것 참... 이봐 쉬나벨, 총상 환자면 어서 옮겨야지! 그렇게 구경만 하고 있을 건가?

쉬나벨 : 나 참, 오랜만에 밖에서 흘러온 사람이라서 내가 의사인 줄도 깜빡하고 있었네 그려. 자, 어서 옮기자고. 이봐, 좀 아프더라도 참게. 뭣하면 정신을 잠깐 정도는 잃어도 괜찮네. 어차피 총알 뺄 때 아파서 일어나게 될 테니까 말이야.

당신은 보리스와 쉬나벨이라고 서로를 부르는 남자 둘에게 양 겨드랑이와 발목이 붙잡혔다.
쾌적한 승차감의 들 것이라고는 도저히 말 할 수 없었지만, 한 결 마음이 편안해진 덕분인지 다시금 정신을 잃었다.`,
    choices: [
      { label: "ㅇ 눈을 뜬다.", to: "B_CATACOMB_TREAT" }
    ]
  },

  B_CATACOMB_TREAT: {
    title: "카타콤 — 응급실",
    text:
`당신이 다시 눈을 뜬 곳은, 지하의 좁은 방이었다.
천장에 매달린 조명은 전구 하나뿐인데도, 이상하게 따뜻한 빛을 내고 있었다.

쉬나벨 : 깼나? 운이 좋아. 총알이 뼈를 건드리진 않았어.

보리스 : 아직 '운이 좋다'고 말할 단계는 아니지. 여기서 나가려면—일단 숨을 쉬어야 하니까.

당신은 무의식적으로 숨을 들이마신다.
…그래, 숨 쉬는 법은 잊지 않았다.

쉬나벨 : 이름은?

당신은 대답하지 못한다.
말이 목구멍에서 멈춘다. 기억은 없다. 하지만, 대답해야 한다는 사실만은 있다.

보리스 : 좋아. 그럼 이름은 '네가 정하면' 된다. 여긴 그래.

쉬나벨은 당신의 허벅지에 감긴 붕대를 다시 조여 묶어준다.
통증이 찌르듯 번지지만, 동시에 피가 멎어가는 느낌이 든다.

(응급 처치 — 체력 +1)

쉬나벨 : 밖에서 온 사람은 기록이 필요해. 기억은 비에 씻기지만, 기록은… 적어도, 손에 남거든.

그가 테이블 위에 마른 수첩 한 권을 놓는다.
표지는 아무 무늬도 없고, 종이는 두껍다. 젖지 않게 코팅된 듯하다.`,
    choices: [
      {
        label: "ㅇ 소지품을 확인한다. (수첩 획득)",
        action: () => {
          // 치료(최대치 제한은 일단 9로 둠)
          state.hp = clamp(state.hp + 1, 0, 9);
          const name = prompt("수첩 표지 안쪽에 적을 이름(호칭)을 입력하세요", state.playerName ?? "");
          if (name && name.trim().length) state.playerName = name.trim();
          state.flags.hasNotebook = true;
          addItem("수첩");
          addNotebookEntry("수첩 — 카타콤 배포본", "비를 피해 기록하라.\n(안티-레이니즘 레지스탕스)");
          learnPurificationCountdown(3);
          toast("수첩을 획득했다.");
        },
        to: "B_AFTER"
      }
    ]
  },

  B_AFTER: {
    title: "카타콤 이후",
    text:
`수첩은 가볍다.
이상하게도, 그 무게가 당신을 현실에 붙잡아 둔다.

이름은 아직 '빌려온 것'일지도 모른다.
하지만 기록은—당신의 손으로 적는 순간부터—당신의 것이 된다.

(다음 메인 노드는 아직 비어 있다. 여기서부터는 애드리언이 B루트를 이어 쓰면 된다.)`,
    choices: [
      { label: "ㅇ 처음으로", action: resetRun }
    ]
  }

  ,
  PURIFICATION_DAY: {
    title: "정화일",
    text:
`검은 하늘이 다시 열리고, 세정 강우가 도시 위로 쏟아진다.

비는 차갑고, 무심하고, 성실하다.
사람의 얼굴을 씻기듯 기억을 씻겨낸다.

당신은 목에 걸린 MAM을 손으로 움켜쥔다.
작동음이 가늘게 이어진다. 기계가 아니었다면—당신은 숨 쉬는 법부터 잊어버렸을 것이다.

어딘가에서 방송이 울린다.

“정화일 집행 중. 시민 여러분께서는 침착히 실내로 대피하십시오.”`,
    choices: [
      { label: "비를 견딘다", action: () => {
          ensurePurificationDefaults();
          // 다음 정화일까지 3일(프로토타입 값)로 리셋
          state.purification.daysRemaining = 3;

          // 후유증: 체력 -1
          state.hp = clamp(Number(state.hp ?? 0) - 1, 0, Number(state.maxHp ?? 5));
          if(state.hp <= 0){
            state.nodeId = "DEATH_BREATH";
            render();
            return;
          }

          // 원래 노드로 복귀
          const back = state.flags?.returnNode ?? "PROLOGUE";
          state.nodeId = back;
          toast("정화일이 지나갔다. (체력 -1)");
        } }
    ]
  },

  DEATH_BREATH: {
    title: "배드 엔딩 — 질식",
    text:
`당신은 모든 기억을 잃었다.
생각하는 법도, 걷는 법도, 살아가는 것도, 존재하는 것도.
숨을 쉬는 것조차.

당신은 질식으로 사망했다.
이 답답한 세상에 절망하여 질식한 것이 아닌,
정말로 숨 쉬는 법을 잊어서.

하지만 이 도시에선 부끄러운 일이 아니다.
매년 수많은 사람들이 대책 없이 세정 강우를 맞아
호흡법을 잊고 사망한다.

부끄러운 일도 아니지만, 특별한 죽음도 아니라는 뜻이다.
당신의 몸은 한 줌 온기조차 보존하지 못한 채,
싸늘히 식어 빗물에 잠겨들었다.`,
    choices: [
      { label: "처음부터 다시", action: resetGame },
      { label: "프롤로그로(상태 유지)", to: "PROLOGUE" }
    ]
  }

  ,

  DEATH_HUNGER: {
    title: "배드 엔딩 — 굶주림",
    text:
`당신은 배가 고프다는 감각조차 또렷하게 붙잡지 못한 채, 하루를 또 넘겼다.

허기는 점점 '생존'의 가장자리로 당신을 밀어냈다.
그 끝에서, 당신은 한 번 더 숨을 들이마시려 했지만—
몸이 더는 움직이지 않았다.

이 도시에서 굶어 죽는 일은 '특별'하지 않다.
정화일이 아니어도, 사람은 사라진다.
이름도, 이유도, 남은 기록도 없이.

당신은 조용히 사망했다.`,
    choices: [
      { label: "처음으로", action: resetGame, to: "PROLOGUE" }
    ]
  }

};

function render(){
  updateStats();
  let node = NODES[state.nodeId];
  if(!node){
    console.warn("Unknown node:", state.nodeId);
    node = { title: "오류", text: `정의되지 않은 노드: ${state.nodeId}

(개발 중인 프로토타입에서 발생할 수 있습니다.)`, choices: [{label:"프롤로그로", to:"PROLOGUE"}] };
  }
  document.getElementById("title").textContent = node.title ?? "";
  document.getElementById("text").textContent = node.text ?? "";
  const choicesEl = document.getElementById("choices");
  choicesEl.innerHTML = "";
  (node.choices ?? []).forEach((c) => {
    const btn = document.createElement("button");
    btn.textContent = c.label;
    btn.addEventListener("click", () => {
      try { if (typeof c.action === "function") c.action(); }
      catch(e){ console.error(e); toast("오류: " + e.message); }
      if (c.to) { state.nodeId = c.to; render(); }
    });
    choicesEl.appendChild(btn);
  });
}

const dlgNotebook = document.getElementById("dlgNotebook");
document.getElementById("btnNotebook").addEventListener("click", () => {
  const content = document.getElementById("notebookContent");
  if(!state.flags.hasNotebook || state.notebookEntries.length === 0){
    content.textContent = "아직 기록이 없습니다.";
  } else {
    const lines = [];
    state.notebookEntries.forEach((e, idx) => {
      const when = new Date(e.at).toLocaleString();
      lines.push(`(${idx+1}) ${e.title}
${e.body}
— ${when}
`);
    });
    content.textContent = lines.join("\n\n");
  }
  dlgNotebook.showModal();
});
document.getElementById("btnCloseNotebook").addEventListener("click", () => dlgNotebook.close());

document.getElementById("btnSave").addEventListener("click", saveGame);
document.getElementById("btnLoad").addEventListener("click", loadGame);
  document.getElementById("btnRest").addEventListener("click", rest);
document.getElementById("btnReset").addEventListener("click", resetGame);

let toastTimer = null;

function enterPurification(){
  // 강제 이벤트 진입 (원래 위치로 돌아가기 위한 포인터 보관)
  if(!state.flags) state.flags = {};
  state.flags.returnNode = state.nodeId;
  state.nodeId = "PURIFICATION_DAY";
}

function rest(){
  // 시간이 흐른다(플레이어가 '모르더라도' 내부적으로는 흘러감)
  if(typeof state.day !== "number") state.day = 0;
  state.day += 1;

  // 휴식 효과: 체력 +1 (상한: maxHp)
  const maxHp = Number(state.maxHp ?? 3);
  state.hp = clamp(Number(state.hp ?? 0) + 1, 0, maxHp);

  // 휴식 패널티: 허기 -1 (바닥 0)
  const maxH = Number(state.maxHunger ?? 5);
  state.hunger = clamp(Number(state.hunger ?? 0) - 1, 0, maxH);

  // 굶주림 페널티: 허기가 0이면 체력 -1
  if(state.hunger === 0){
    state.hp = clamp(Number(state.hp ?? 0) - 1, 0, maxHp);
  }

  // 다음 정화일까지 카운트 감소
  advanceDays(1);

  // D-0이면 정화일 이벤트로 강제 진입 (MAM 없으면 즉사)
  ensurePurificationDefaults();
  if(state.purification.daysRemaining === 0){
    // 정화일을 "체감"하는 순간부터는 주기를 알게 된다
    state.purification.known = true;
    const hasMAM = (state.mam?.level ?? 0) > 0;
    if(!hasMAM){
      state.nodeId = "DEATH_BREATH";
    } else {
      if(!state.flags) state.flags = {};
      state.flags.returnNode = state.nodeId;
      state.nodeId = "PURIFICATION_DAY";
      // (프로토타입) 다음 정화일까지 3일로 리셋
      state.purification.daysRemaining = 3;
    }
  }

  // 체력이 0이면(굶주림 포함) 사망 처리
  if((state.hp ?? 0) <= 0 && state.nodeId !== "DEATH_BREATH"){
    state.nodeId = "DEATH_HUNGER";
  }

  render();
  const starve = (state.hunger === 0) ? " / 굶주림(-1)" : "";
  toast(`휴식했다. (Day +1 / 체력 +1 / 허기 -1${starve})`);
}
function toast(msg){
  let el = document.getElementById("toast");
  if(!el){
    el = document.createElement("div");
    el.id = "toast";
    el.style.position = "fixed";
    el.style.left = "50%";
    el.style.bottom = "18px";
    el.style.transform = "translateX(-50%)";
    el.style.background = "rgba(18,20,27,.95)";
    el.style.border = "1px solid var(--line)";
    el.style.color = "var(--text)";
    el.style.padding = "10px 12px";
    el.style.borderRadius = "999px";
    el.style.fontSize = "14px";
    el.style.zIndex = "999";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.opacity = "1";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.style.opacity = "0"; }, 1400);
}

render();

</script>
</body>
</html>
